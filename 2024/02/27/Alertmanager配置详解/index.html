<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="博客" />
       
      <meta name="description" content="日常随笔" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Alertmanager配置详解 |  Lijintao&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="Lijintao's Blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="Alertmanager-Alertmanager配置详解"
  class="article article-type-Alertmanager"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Alertmanager配置详解
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/02/27/Alertmanager%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2024-02-27T09:29:58.000Z" itemprop="datePublished">2024-02-27</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Alertmanager/">Alertmanager</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">5.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">22 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、配置概述"><a href="#一、配置概述" class="headerlink" title="一、配置概述"></a>一、配置概述</h2><h3 id="1-配置简介"><a href="#1-配置简介" class="headerlink" title="1. 配置简介"></a>1. 配置简介</h3><p>Alertmanager主要负责对Prometheus产生的告警进行统一处理，在Alertmanager配置中一般会包含以下几个主要部分：</p>
<ul>
<li>全局配置（global）：用于定义一些全局的公共参数，如全局的SMTP配置，Slack配置等内容；</li>
<li>模板（templates）：用于定义告警通知时的模板，如HTML模板，邮件模板等；</li>
<li>告警路由（route）：根据标签匹配，确定当前告警应该如何处理；</li>
<li>接收人（receivers）：接收人是一个抽象的概念，它可以是一个邮箱也可以是微信，Slack或者Webhook等，接收人一般配合告警路由使用；</li>
<li>抑制规则（inhibit_rules）：合理设置抑制规则可以减少垃圾告警的产生</li>
</ul>
<h3 id="2-global配置"><a href="#2-global配置" class="headerlink" title="2.global配置"></a>2.global配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  [ resolve_timeout: &lt;duration&gt; | default = 5m ] # 当Alertmanager持续多长时间未接收到告警后标记告警状态为resolved（已解决）</span><br><span class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</span><br><span class="line">  [ smtp_smarthost: &lt;string&gt; ]</span><br><span class="line">  [ smtp_hello: &lt;string&gt; | default = &quot;localhost&quot; ] </span><br><span class="line">  [ smtp_auth_username: &lt;string&gt; ]</span><br><span class="line">  [ smtp_auth_password: &lt;secret&gt; ] </span><br><span class="line">  [ smtp_auth_identity: &lt;string&gt; ]</span><br><span class="line">  [ smtp_auth_secret: &lt;secret&gt; ]</span><br><span class="line">  [ smtp_require_tls: &lt;bool&gt; | default = true ]</span><br><span class="line">  [ slack_api_url: &lt;secret&gt; ]</span><br><span class="line">  [ victorops_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ victorops_api_url: &lt;string&gt; | default = &quot;https://alert.victorops.com/integrations/generic/20131114/alert/&quot; ]</span><br><span class="line">  [ pagerduty_url: &lt;string&gt; | default = &quot;https://events.pagerduty.com/v2/enqueue&quot; ]</span><br><span class="line">  [ opsgenie_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ opsgenie_api_url: &lt;string&gt; | default = &quot;https://api.opsgenie.com/&quot; ]</span><br><span class="line">  [ hipchat_api_url: &lt;string&gt; | default = &quot;https://api.hipchat.com/&quot; ]</span><br><span class="line">  [ hipchat_auth_token: &lt;secret&gt; ]</span><br><span class="line">  [ wechat_api_url: &lt;string&gt; | default = &quot;https://qyapi.weixin.qq.com/cgi-bin/&quot; ]</span><br><span class="line">  [ wechat_api_secret: &lt;secret&gt; ]</span><br><span class="line">  [ wechat_api_corp_id: &lt;string&gt; ]</span><br><span class="line">  [ http_config: &lt;http_config&gt; ]</span><br><span class="line"></span><br><span class="line">templates:</span><br><span class="line">  [ - &lt;filepath&gt; ... ]</span><br><span class="line"></span><br><span class="line">route: &lt;route&gt;</span><br><span class="line"></span><br><span class="line">receivers:</span><br><span class="line">  - &lt;receiver&gt; ...</span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">  [ - &lt;inhibit_rule&gt; ... ]</span><br></pre></td></tr></table></figure>

<p>global配置中主要关注resolve_timeout的配置。其他配置为SMTP配置，Slack配置等告警媒介的相关配置，在后续章节配置不同的告警媒介时会具体讲到。也可参考官方文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/">https://prometheus.io/docs/alerting/latest/configuration/</a></p>
<h2 id="二、告警路由"><a href="#二、告警路由" class="headerlink" title="二、告警路由"></a>二、告警路由</h2><h3 id="1-配置详解"><a href="#1-配置详解" class="headerlink" title="1. 配置详解"></a>1. 配置详解</h3><p>告警路由可以使我们的告警根据不同的标签告警匹配到不同的渠道发送处理。配置文件解析如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">route: #配置路由树</span><br><span class="line">  receiver: # 接收组名，对于不同级别的告警，我们可能多个完全不同的接收组进行处理。</span><br><span class="line">  group_by: []# 根据label标签的key进行匹配，如果是多个，就要多个都匹配</span><br><span class="line">  continue: false # 告警是否去继续路由子节点</span><br><span class="line">  match: [labelname:labelvalue,labelname1,labelvalue1] # 通过标签去匹配这次告警是否符合这个路由节点。</span><br><span class="line">  match_re: [labelname:regex] # 通过正则表达是匹配标签，意义同上</span><br><span class="line">  group_wait: 30s  # 组内等待时间，同一分组内收到第一个告警等待多久开始发送，目标是为了同组消息同时发送，不占用告警信息，默认30s</span><br><span class="line">  group_interval: 5m # 当组内已经发送过一个告警，组内若有新增告警需要等待的时间，默认为5m,这条要确定组内信息是影响同一业务才能设置，若分组不合理，可能导致告警延迟，造成影响</span><br><span class="line">  repeat_inteval: 4h # 告警已经发送，且无新增告警，若重复告警需要间隔多久 默认4h 属于重复告警，时间间隔应根据告警的严重程度来设置</span><br><span class="line">  routes:</span><br><span class="line">    - route: #路由子节点 配置信息跟主节点的路由信息一致</span><br></pre></td></tr></table></figure>

<h3 id="2-路由匹配"><a href="#2-路由匹配" class="headerlink" title="2. 路由匹配"></a>2. 路由匹配</h3><p>每一个告警都会从配置文件中顶级的route进入路由树，需要注意的是顶级的route必须匹配所有告警(即不能有任何的匹配设置match和match_re)，每一个路由都可以定义自己的接受人以及匹配规则。默认情况下，告警进入到顶级route后会遍历所有的子节点，直到找到最深的匹配route，并将告警发送到该route定义的receiver中。但如果route中设置<strong>continue</strong>的值为false，那么告警在匹配到第一个子节点之后就直接停止。如果<strong>continue</strong>为true，报警则会继续进行后续子节点的匹配。如果当前告警匹配不到任何的子节点，那该告警将会基于当前路由节点的接收器配置方式进行处理。<br>其中告警的匹配有两种方式可以选择。一种方式基于字符串验证，通过设置<strong>match</strong>规则判断当前告警中是否存在标签labelname并且其值等于labelvalue。第二种方式则基于正则表达式，通过设置<strong>match_re</strong>验证当前告警标签的值是否满足正则表达式的内容。<br>如果警报已经成功发送通知, 如果想设置发送告警通知之前要等待时间，则可以通过<strong>repeat_interval</strong>参数进行设置。</p>
<h3 id="3-告警分组"><a href="#3-告警分组" class="headerlink" title="3. 告警分组"></a>3. 告警分组</h3><p>Alertmanager可以对告警通知进行分组，将多条告警合合并为一个通知，避免短期内频繁收到多条相关告警。这里我们可以使用<strong>group_by</strong>来定义分组规则。基于告警中包含的标签，如果满足<strong>group_by</strong>中定义标签名称，那么这些告警将会合并为一个通知发送给接收器。<br>有的时候为了能够一次性收集和发送更多的相关信息时，可以通过<strong>group_wait</strong>参数设置等待时间，如果在等待时间内当前group接收到了新的告警，这些告警将会合并为一个通知向receiver发送。<br>而<strong>group_interval</strong>配置，则用于定义相同的Group之间发送告警通知的时间间隔。</p>
<h3 id="4-配置举例：告警分组功能的实现"><a href="#4-配置举例：告警分组功能的实现" class="headerlink" title="4. 配置举例：告警分组功能的实现"></a>4. 配置举例：告警分组功能的实现</h3><blockquote>
<p>一个完善的告警系统，告警路由通常是非常复杂的，为了便于运维人员配置，prometheus官方开发了一个路由配置树工具。<a target="_blank" rel="noopener" href="https://www.prometheus.io/webtools/alerting/routing-tree-editor/">https://www.prometheus.io/webtools/alerting/routing-tree-editor/</a></p>
</blockquote>
<ul>
<li>默认情况下所有的告警都会发送给管理员default-receiver，因此在Alertmanager的配置文件的根路由中，对告警信息按照集群以及告警的名称对告警进行分组。</li>
<li>如果告警是来源于数据库服务如MySQL或者pgsql，此时则需要将告警发送给相应的数据库管理员(dba)。这里定义了一个单独子路由，如果告警中包含service标签，并且service为mysql或者pgsql,则向dba-pager发送告警通知，由于这里没有定义group_by等属性，这些属性的配置信息将从上级路由继承，dba-pager将会接收到按cluser和alertname进行分组的告警通知。</li>
<li>而某些告警规则来源可能来源于开发团队，这些告警中通过添加标签team来标示这些告警的创建者。在Alertmanager配置文件的告警路由下，定义单独子路由用于处理这一类的告警通知，如果匹配到告警中包含标签team，并且team的值为dev，Alertmanager将会按照标签product和environment对告警进行分组。此时如果应用出现异常，开发团队就能清楚的知道哪一个环境(environment)中的哪一个应用程序出现了问题，可以快速对应用进行问题定位。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  receiver: &#x27;default-receiver&#x27;</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 4h</span><br><span class="line">  group_by: [cluster, alertname]</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: &#x27;dba-pager&#x27;</span><br><span class="line">    group_wait: 10s</span><br><span class="line">    match_re:</span><br><span class="line">      service: mysql|pgsql</span><br><span class="line">  - receiver: &#x27;dev-pager&#x27;</span><br><span class="line">    group_by: [product, environment]</span><br><span class="line">    match:</span><br><span class="line">      team: dev</span><br></pre></td></tr></table></figure>

<h3 id="5-配置举例：告警分级功能的实现"><a href="#5-配置举例：告警分级功能的实现" class="headerlink" title="5. 配置举例：告警分级功能的实现"></a>5. 配置举例：告警分级功能的实现</h3><ul>
<li>在每条告警配置的标签中添加severity配置，有三种等级，分别为warning、critical和emergency。严重等级依次递增。</li>
<li>不论收到那种等级的告警，都会邮件通知给默认的管理员default-receiver</li>
<li>当告警等级为critical时，比较严重的告警，发送短信通知，每2h重复发送一次，直到问题解决</li>
<li>当告警等级为emergency时，特别严重的告警，打电话通知，每1h重复发送一次，直到问题解决</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">  receiver: &#x27;default-receiver&#x27;</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 4h</span><br><span class="line">  group_by: [cluster, alertname]</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: &#x27;SMS-pager&#x27;</span><br><span class="line">    repeat_inteval: 2h</span><br><span class="line">    group_wait: 10s</span><br><span class="line">    match:</span><br><span class="line">      severity: critical</span><br><span class="line">  - receiver: &#x27;phone-pager&#x27;</span><br><span class="line">    repeat_inteval: 1h</span><br><span class="line">    group_wait: 10s</span><br><span class="line">    match:</span><br><span class="line">      severity: emergency</span><br></pre></td></tr></table></figure>

<h2 id="三、告警接收"><a href="#三、告警接收" class="headerlink" title="三、告警接收"></a>三、告警接收</h2><h3 id="1-receiver配置介绍"><a href="#1-receiver配置介绍" class="headerlink" title="1. receiver配置介绍"></a>1. receiver配置介绍</h3><p>在Alertmanager中路由负责对告警信息进行分组匹配，并向告警接收器发送通知。每一个receiver具有一个全局唯一的名称，并且对应一个或者多个通知方式，告警接收配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">receivers:</span><br><span class="line">- name: # 接收器名称，全局唯一</span><br><span class="line"></span><br><span class="line">  # Configurations for several notification integrations.</span><br><span class="line">  email_configs:</span><br><span class="line">    [ - &lt;email_config&gt;, ... ]</span><br><span class="line">  pagerduty_configs:</span><br><span class="line">    [ - &lt;pagerduty_config&gt;, ... ]</span><br><span class="line">  pushover_configs:</span><br><span class="line">    [ - &lt;pushover_config&gt;, ... ]</span><br><span class="line">  slack_configs:</span><br><span class="line">    [ - &lt;slack_config&gt;, ... ]</span><br><span class="line">  opsgenie_configs:</span><br><span class="line">    [ - &lt;opsgenie_config&gt;, ... ]</span><br><span class="line">  webhook_configs:</span><br><span class="line">    [ - &lt;webhook_config&gt;, ... ]</span><br><span class="line">  victorops_configs:</span><br><span class="line">    [ - &lt;victorops_config&gt;, ... ]</span><br><span class="line">  wechat_configs:</span><br><span class="line">    [ - &lt;wechat_config&gt;, ... ]</span><br><span class="line">- name: # 另一个接收器名称，全局唯一</span><br><span class="line">	………………</span><br></pre></td></tr></table></figure>

<p>目前官方内置的第三方通知集成包括：邮件、 即时通讯软件（如Slack、Hipchat）、移动应用消息推送(如Pushover)和自动化运维工具（例如：Pagerduty、Opsgenie、Victorops）。Alertmanager的通知方式中还可以支持Webhook，通过这种方式开发者可以实现更多个性化的扩展支持。<br>更多告警媒介配置请参考官方文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/#receiver">https://prometheus.io/docs/alerting/latest/configuration/#receiver</a></p>
<h3 id="2-邮件告警配置"><a href="#2-邮件告警配置" class="headerlink" title="2. 邮件告警配置"></a>2. 邮件告警配置</h3><p>Alertmanager使用邮箱通知，用户只需要全局配置中定义好SMTP相关的配置，并且在receiver中定义接收方的邮件地址即可，此处以qq邮箱为例：</p>
<ul>
<li>需要先登录QQ邮箱，开通smtp功能，并获取授权码。smtp_auth_password填写的信息，就是授权码，而非QQ邮箱的登录密码！</li>
</ul>
<p><img src="/images/1709026478-8d5b028f8b2e3a30d02ba5a7fafee655.jpg" alt="image.png"></p>
<ul>
<li>Alertmanager配置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-conf</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |-</span><br><span class="line">    global: </span><br><span class="line">      smtp_smarthost: &#x27;smtp.qq.com:465&#x27; </span><br><span class="line">      smtp_from: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_username: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_password: &#x27;XXXX&#x27; </span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    route: </span><br><span class="line">      receiver: email </span><br><span class="line">      group_by: </span><br><span class="line">      - alertname </span><br><span class="line">      group_wait: 10s </span><br><span class="line">      group_interval: 10s </span><br><span class="line">      repeat_interval: 1h</span><br><span class="line">    receivers: </span><br><span class="line">    - name: &#x27;email&#x27; </span><br><span class="line">      email_configs: </span><br><span class="line">      - to: &#x27;1111@qq.com&#x27;</span><br><span class="line">      	send_resolved: false #告警解除发送恢复通知</span><br></pre></td></tr></table></figure>

<ul>
<li>告警测试</li>
</ul>
<p><img src="/images/1709026478-9779034ceb99ee8aebd50cf4669560cc.jpg" alt="image.png"><br><img src="/images/1709026478-222df5ef03dbbdfe227eb437f56fb8b6.jpg" alt="image.png"><br><img src="/images/1709026478-cc5a733f6b7101e5bd46a9343ba7eb0a.jpg" alt="image.png"></p>
<h2 id="四、告警模板"><a href="#四、告警模板" class="headerlink" title="四、告警模板"></a>四、告警模板</h2><p>Alertmanager提供了一套基于Go的默认模板系统。Alertmanager也支持用户定义和使用自己的模板。</p>
<h3 id="1-模板字符串"><a href="#1-模板字符串" class="headerlink" title="1. 模板字符串"></a>1. 模板字符串</h3><p>和prometheus配置模板字符串一样。具体参考官方文档<a target="_blank" rel="noopener" href="https://prometheus.io/blog/2016/03/03/custom-alertmanager-templates/#customize">https://prometheus.io/blog/2016/03/03/custom-alertmanager-templates/#customize</a>，实际生产环境使用较少，此处不再介绍。</p>
<h3 id="2-模板文件"><a href="#2-模板文件" class="headerlink" title="2. 模板文件"></a>2. 模板文件</h3><p>官方语法介绍：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/notifications/">https://prometheus.io/docs/alerting/latest/notifications/</a><br>官方模板链接：<a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl">https://github.com/prometheus/alertmanager/blob/master/template/default.tmpl</a><br>邮件模板链接：<a target="_blank" rel="noopener" href="https://github.com/mailgun/transactional-email-templates">https://github.com/mailgun/transactional-email-templates</a></p>
<ul>
<li>首先定义模板文件configmap</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-email-tmpl</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  email-monitor.tmpl: |-</span><br><span class="line">    &#123;&#123; define &quot;email-monitor.html&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">    &lt;h1&gt;告警&lt;/h1&gt;</span><br><span class="line">    &lt;table border=&quot;5&quot;&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;报警项&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;实例&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;报警详情&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;报警阀值&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range $i, $alert := .Alerts &#125;&#125;</span><br><span class="line">            &lt;tr&gt;&lt;td&gt;&#123;&#123; index $alert.Labels &quot;alertname&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Labels &quot;instance&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Annotations &quot;description&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Annotations &quot;value&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; $alert.StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">    &lt;h1&gt;恢复&lt;/h1&gt;</span><br><span class="line">    &lt;table border=&quot;5&quot;&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;报警项&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;实例&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;报警详情&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;报警阀值&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;开始时间&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range $i, $alert := .Alerts &#125;&#125;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Labels &quot;alertname&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Labels &quot;instance&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Annotations &quot;description&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; index $alert.Annotations &quot;value&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&#123;&#123; $alert.StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后修改Alertmanager-config，指定模板文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-conf</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |-</span><br><span class="line">    global: </span><br><span class="line">      smtp_smarthost: &#x27;smtp.qq.com:465&#x27; </span><br><span class="line">      smtp_from: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_username: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_password: &#x27;XXXXXX&#x27; </span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    templates:</span><br><span class="line">    - &#x27;/etc/alertmanager/tmpl/*.tmpl&#x27; # 指定自定义告警模板位置</span><br><span class="line">    route: </span><br><span class="line">      receiver: email </span><br><span class="line">      group_by: </span><br><span class="line">      - alertname </span><br><span class="line">      group_wait: 10s </span><br><span class="line">      group_interval: 10m</span><br><span class="line">      repeat_interval: 1h</span><br><span class="line">    receivers: </span><br><span class="line">    - name: &#x27;email&#x27; </span><br><span class="line">      email_configs: </span><br><span class="line">      - to: &#x27;1554382111@qq.com&#x27;</span><br><span class="line">        send_resolved: false # 告警解除发送恢复通知</span><br><span class="line">        html: &#x27;&#123;&#123; template &quot;email-monitor.html&quot; . &#125;&#125;&#x27; # 指定告警模板</span><br><span class="line">        headers: &#123; Subject: &quot;告警邮件&quot; &#125; # 邮件主题 如果不写也可以在模板中定义默认值</span><br></pre></td></tr></table></figure>

<ul>
<li>最后修改Alertmanager资源清单，将模板配置文件挂载</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: alertmanager</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alertmanager</span><br><span class="line">        image: prom/alertmanager:v0.23.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;4Gi&quot;</span><br><span class="line">            cpu: &quot;4&quot;</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;128Mi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        args:</span><br><span class="line">          - &#x27;--config.file=/etc/alertmanager/config/config.yaml&#x27;</span><br><span class="line">          - &#x27;--storage.path=/alertmanager&#x27;</span><br><span class="line">          - &#x27;--log.level=debug&#x27; </span><br><span class="line">        ports:</span><br><span class="line">        - name: alertmanager</span><br><span class="line">          containerPort: 9093</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: alertmanager-conf</span><br><span class="line">          mountPath: /etc/alertmanager/config</span><br><span class="line">        - name: alertmanager-email-tmpl</span><br><span class="line">          mountPath: /etc/alertmanager/tmpl</span><br><span class="line">        - name: alertmanager</span><br><span class="line">          mountPath: /alertmanager</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - labelSelector:</span><br><span class="line">              matchExpressions:</span><br><span class="line">              - key: app</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - alertmanager</span><br><span class="line">            topologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">      volumes:</span><br><span class="line">      - name: alertmanager-conf</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-conf</span><br><span class="line">      - name: alertmanager-email-tmpl</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-email-tmpl</span><br><span class="line">      - name: alertmanager</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一切准备就绪后，接下来模拟节点宕机，测试告警是否正常发出</li>
</ul>
<p><img src="/images/1709026478-8123c621c184bd7c9f9b293bab58c4b8.jpg" alt="image.png"></p>
<h2 id="五、告警静默"><a href="#五、告警静默" class="headerlink" title="五、告警静默"></a>五、告警静默</h2><p>接着上文提到的操作，现在work3节点持续处于宕机状态，并配置了repeat_interval: 1h，也就是如果故障没有解决，每1h会通知一次，直到故障恢复。但有可能这台服务器硬件损坏，短期内无法恢复，为了避免告警打扰，可以设置临时静默。</p>
<h3 id="1-查看告警"><a href="#1-查看告警" class="headerlink" title="1. 查看告警"></a>1. 查看告警</h3><p>首先，查看Alertmanager的alerts。查看当前未恢复的告警<br><img src="/images/1709026478-d4626e4e4d2f6a8b2571259782ca7c1b.jpg" alt="image.png"></p>
<h3 id="2-设置静默"><a href="#2-设置静默" class="headerlink" title="2. 设置静默"></a>2. 设置静默</h3><p>然后点击silence，对这个告警设置临时静默，然后填写静默持续时间(默认2h)，以及创建这和备注，填写完成后点击create创建静默规则<br><img src="/images/1709026478-869b2b2f3aabec19afbcdd89f6354fed.jpg" alt="image.png"></p>
<h3 id="3-查看验证"><a href="#3-查看验证" class="headerlink" title="3. 查看验证"></a>3. 查看验证</h3><ul>
<li>此时在alert中就不会看到激活的告警内容<img src="/images/1709026478-c0016a076859812f549f9ec4937d7c23.jpg" alt="image.png"></li>
<li>点击silence就可以查看到已经静默的告警</li>
</ul>
<p><img src="/images/1709026478-4d5ec6b8bfdc9d9674569909675754c0.jpg" alt="image.png"></p>
<h2 id="六、告警抑制"><a href="#六、告警抑制" class="headerlink" title="六、告警抑制"></a>六、告警抑制</h2><p>Alertmanager的抑制机制可以避免当某种问题告警产生之后用户接收到大量由此问题导致的一系列的其它告警通知。例如当集群不可用时，用户可能只希望接收到一条告警，告诉他这时候集群出现了问题，而不是大量的如集群中的应用异常、中间件服务异常的告警通知。</p>
<h3 id="1-基本格式"><a href="#1-基本格式" class="headerlink" title="1. 基本格式"></a>1. 基本格式</h3><ul>
<li>Alertmanager中使用inhibit_rules定义一组告警的抑制规则，基本格式如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">inhibit_rules:</span><br><span class="line">  - source_match: # 第一条抑制规则</span><br><span class="line">    target_match: # 匹配标签</span><br><span class="line">    target_match_re: # 匹配正则</span><br><span class="line">    equal: # 在源和目标中具有相同值的标签</span><br><span class="line">  - source_match: # 第二条抑制规则</span><br><span class="line">    …………</span><br></pre></td></tr></table></figure>

<p>当已经发送的告警通知匹配到target_match和target_match_re规则，当有新的告警规则如果满足source_match或者定义的匹配规则，并且已发送的告警与新产生的告警中equal定义的标签完全相同，则启动抑制机制，新的告警不会发送。</p>
<h3 id="2-模拟测试-抑制前"><a href="#2-模拟测试-抑制前" class="headerlink" title="2. 模拟测试-抑制前"></a>2. 模拟测试-抑制前</h3><p>场景模拟：当前当前集群的work2上面运行了nginx服务，访问地址为<a target="_blank" rel="noopener" href="http://192.168.10.12/test.html">http://192.168.10.12/test.html</a>，并且配置了网络探针，检测<a target="_blank" rel="noopener" href="http://192.168.10.12/test.html">http://192.168.10.12/test.html</a>页面状态码是否为200，以及80端口的TCP检测，还有node_exporter宕机检测。并且都设置了告警，如果此时服务器宕机了，那么我将收到大量无用的告警信息，反而不好排查问题原因。</p>
<ul>
<li>我们先在work2服务器上运行nginx服务，并添加测试页面，模拟线上生产环境的web服务</li>
</ul>
<p><img src="/images/1709026478-23b211f20fa7a01c50e8618923a1a0ee.jpg" alt="image.png"></p>
<ul>
<li>然后部署blackbox-exporter组件用于网络检测</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter-svc</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 9115</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: blackbox-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/blackbox-exporter</span><br><span class="line">        name: blackbox-exporter</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9115</span><br><span class="line">          name: http</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/healthy</span><br><span class="line">            port: http</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          timeoutSeconds: 60</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/healthy</span><br><span class="line">            port: http</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 60</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1 </span><br><span class="line">            memory: &quot;2Gi&quot;</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 250m</span><br><span class="line">            memory: 640Mi</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在prometheus配置文件中添加网络检测相关target</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  prometheus.yaml: |-</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      evaluation_interval: 15s</span><br><span class="line">    rule_files:</span><br><span class="line">    - /etc/prometheus/rules/*.yaml</span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">        - targets: [&quot;alertmanager:9093&quot;]</span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: blackbox_http_exporter</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - http://192.168.10.12/test.html</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter-svc:9115</span><br><span class="line">    - job_name: blackbox_tcp_exporter</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [tcp_connect]</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 192.168.10.12:80</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter-svc:9115</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来查看prometheus-target页面，确认采集项成功添加</li>
</ul>
<p><img src="/images/1709026478-f2f28e6fe70e20fd311cc224dfaa753e.jpg" alt="image.png"></p>
<ul>
<li>接下来添加告警规则配置，现在有三条告警，第一条为node status is WODN，事件等级为emergency，第二条为nginx service status is WODN，事件等级为critical，第三条为page status code error，事件等级为critical。三个告警事件从上到下层层依赖，重要程度依次递减。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-rule</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus-rule</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  alert-rules.yaml: |-</span><br><span class="line">    groups:</span><br><span class="line">    - name: node-alert</span><br><span class="line">      rules:</span><br><span class="line">      - alert: node status is WODN</span><br><span class="line">        expr: up&#123;job=&quot;node_exporter&quot;&#125; == 0</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: emergency</span><br><span class="line">          instance: &quot;&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;node: &#123;&#123; $labels.instance &#125;&#125; down&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125; down more than 1 minutes&quot;</span><br><span class="line">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      - alert: nginx service status is WODN</span><br><span class="line">        expr: probe_success&#123;instance=&quot;192.168.10.12:80&quot;&#125; == 0</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: critical</span><br><span class="line">          instance: &quot;&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;node: &#123;&#123; $labels.instance &#125;&#125; nginx service down&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125; nginx service down more than 1 minutes&quot;</span><br><span class="line">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      - alert: page status code error</span><br><span class="line">        expr: probe_http_status_code&#123;instance=&quot;http://192.168.10.12/test.html&quot;&#125; != 200</span><br><span class="line">        for: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">          instance: &quot;&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">        annotations:</span><br><span class="line">          summary: &quot;url: &#123;&#123; $labels.instance &#125;&#125; page status code error&quot;</span><br><span class="line">          description: &quot;&#123;&#123;$labels.instance&#125;&#125; page status code error more than 1 minutes&quot;</span><br><span class="line">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>先查看告警规则状态，当前三条告警规则都没有被触发</li>
</ul>
<p><img src="/images/1709026478-6ad11bd01a208407f730c59b4b64cb75.jpg" alt="image.png"></p>
<ul>
<li>接下来先关闭其中任意一个节点，模拟服务器宕机。查看prometheus告警信息，三条告警被成功触发。</li>
</ul>
<p><img src="/images/1709026478-8096171d538e2f0b23b3b78aca51d8cb.jpg" alt="image.png"></p>
<ul>
<li>接下来查看Alertmanager告警列表，同样的收到了三条告警信息</li>
</ul>
<p><img src="/images/1709026478-efc83233a39b395f71f383439b525aaa.jpg" alt="image.png"></p>
<ul>
<li>可以看到由于节点宕机，导致这台主机的nginx服务和对应的web页面均无法访问而产生了大量告警。在实际生产环境中，服务的依赖关系错综复杂，例如交换机端口down，可能会导致服务器间通信异常，从而收到大量的相关告警，反而无法快速定位出问题。遇到这种情况，就需要梳理告警之间的依赖关系，配置合理的告警抑制策略，避免告警风暴产生。</li>
</ul>
<h3 id="3-模拟测试-抑制后"><a href="#3-模拟测试-抑制后" class="headerlink" title="3. 模拟测试-抑制后"></a>3. 模拟测试-抑制后</h3><p>接下来，我们先对这三条告警依赖关系做一个简单的梳理，三条告警的依赖关系如下图所示：</p>
<ul>
<li>接下来，我们先对nginx服务异常和web页面访问异常告警添加一个额外的标签<code>project: test-web</code>，标注这两条告警同属一个业务。接下来查看这三条告警的label，后面配置的告警抑制规则是根据每条告警的标签匹配的。</li>
</ul>
<p><img src="/images/1709026478-ef9f2608a3fe4b588b1c154545f2b885.jpg" alt="image.png"><br><img src="/images/1709026478-5ccb861084828567f50cde72066477da.jpg" alt="image.png"><br><img src="/images/1709026478-828106221685594a5c13a047b06015fb.jpg" alt="image.png"></p>
<ul>
<li>接下来，我们编写告警抑制规则</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-conf</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |-</span><br><span class="line">    global: </span><br><span class="line">      smtp_smarthost: &#x27;smtp.qq.com:465&#x27; </span><br><span class="line">      smtp_from: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_username: &#x27;cuiliangblog@qq.com&#x27; </span><br><span class="line">      smtp_auth_password: &#x27;XXXXXXX&#x27; </span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    templates:</span><br><span class="line">    - &#x27;/etc/alertmanager/tmpl/*.tmpl&#x27; # 指定自定义告警模板位置</span><br><span class="line">    route: </span><br><span class="line">      receiver: email </span><br><span class="line">      group_by: </span><br><span class="line">      - alertname </span><br><span class="line">      group_wait: 10s </span><br><span class="line">      group_interval: 10m</span><br><span class="line">      repeat_interval: 1h</span><br><span class="line">    receivers: </span><br><span class="line">    - name: &#x27;email&#x27; </span><br><span class="line">      email_configs: </span><br><span class="line">      - to: &#x27;1554382111@qq.com&#x27;</span><br><span class="line">        send_resolved: false # 告警解除发送恢复通知</span><br><span class="line">        html: &#x27;&#123;&#123; template &quot;email-monitor.html&quot; . &#125;&#125;&#x27; # 指定告警模板</span><br><span class="line">        headers: &#123; Subject: &quot;告警邮件&quot; &#125; # 邮件主题 如果不写也可以在模板中定义默认值</span><br><span class="line">    inhibit_rules:  </span><br><span class="line">    - source_match: </span><br><span class="line">        alertname: &#x27;node status is WODN&#x27;  </span><br><span class="line">        instance: k8s-work2  </span><br><span class="line">      target_match:</span><br><span class="line">        project: test-web  </span><br><span class="line">    - source_match: </span><br><span class="line">        severity: critical  </span><br><span class="line">      target_match:</span><br><span class="line">        severity: warning</span><br><span class="line">      equal:</span><br><span class="line">      - project</span><br></pre></td></tr></table></figure>

<p>其中第一条抑制规则含义为：当收到告警的标签中instance&#x3D;k8s-work2并且alertname&#x3D;’node status is WODN’时，触发抑制规则。后续收到的告警标签中project&#x3D;test-web的告警将全部被抑制（也就是nginx告警和page code告警）<br>第二条抑制规则含义为：当收到告警的标签中severity&#x3D;critical时，触发抑制规则，包含severity&#x3D;warning的告警将被抑制。需要注意的是，还添加了一个equal标签，作用就是source和target中都包含project这个标签，且他们的值一致时，才会抑制（也就是抑制page code告警）</p>
<ul>
<li>我们先将服务恢复正常状态</li>
</ul>
<p><img src="/images/1709026478-fafaa67a31c4d882c1ed8e7ba476acd5.jpg" alt="image.png"></p>
<ul>
<li>接下来关闭nginx服务，查看prometheus会发现有page status code error和nginx service status isWODN两条告警事件</li>
</ul>
<p><img src="/images/1709026478-8c4c48d891d4068ef6968e1cdc79f387.jpg" alt="image.png"></p>
<ul>
<li>但此时Alertmanager只有nginx service status is WODN这一条告警事件，另一条page status code error告警被成功抑制。</li>
</ul>
<p><img src="/images/1709026478-5e15c4c66843d07ca297c262376ada97.jpg" alt="image.png"></p>
<ul>
<li>接下来关闭work2节点，模拟服务器宕机。查看prometheus告警这三条全部触发</li>
</ul>
<p><img src="/images/1709026478-bd83c4d8c00f4500646a20afb91e5d40.jpg" alt="image.png"></p>
<ul>
<li>查看Alertmanager告警列表，只有一条node status is WODN，其余两条告警被成功抑制。</li>
</ul>
<p><img src="/images/1709026478-042cf07e761d5b8f675d7327445ef521.jpg" alt="image.png"></p>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/02/27/Alertmanager%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Alertmanager/" rel="tag">Alertmanager</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/02/27/grafana-API%E4%BD%BF%E7%94%A8/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            grafana API使用
          
        </div>
      </a>
    
    
      <a href="/2024/02/27/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-Consul%E4%BB%8B%E7%BB%8D/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">服务注册中心-Consul介绍</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> JinTao Li
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="https://beian.miit.gov.cn/" target="_black" rel="nofollow">鲁ICP备88888888</a>
        </li>
        
    </ul>
    <ul>
      
      <li>
          <img src="/images/beian.png"></img>
          <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=01234567890123" target="_black" rel="nofollow">青岛公安网备01234567890123号</a>
      </li>
        
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Lijintao&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://blog.csdn.net/u013235026">CSDN</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/jintaoli">博客园</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/images/272a163694dd8a415a43dbf85ac34778.jpg">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=2142256392&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    
<script>
  const password = "jintao1210";
  const lock_password = window.sessionStorage.getItem("lock_password");
  console.log(password, lock_password);
  if (lock_password !== password) {
    Swal.fire({
      title: "请输入访问密码",
      input: "text",
      inputAttributes: {
        autocapitalize: "off",
      },
      showCancelButton: false,
      showLoaderOnConfirm: true,
      allowOutsideClick: false,
      confirmButtonText: "确定",
    }).then((result) => {
      console.log(result);
      if (result.isConfirmed) {
        console.log(password);
        if (result.value === password) {
          window.sessionStorage.setItem("lock_password", result.value);
        } else {
          Swal.fire({
            icon: "error",
            title: "密码错误，请重试",
            confirmButtonText: "确定",
            allowOutsideClick: false,
          }).then(() => {
            window.location.reload();
          });
        }
      }
    });
  }
</script>


  </div>
</body>

</html>