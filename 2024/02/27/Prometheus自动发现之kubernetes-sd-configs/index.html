<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="博客" />
       
      <meta name="description" content="日常随笔" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Prometheus自动发现之kubernetes_sd_configs |  Lijintao&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="Lijintao's Blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="Prometheus-Prometheus自动发现之kubernetes-sd-configs"
  class="article article-type-Prometheus"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Prometheus自动发现之kubernetes_sd_configs
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/02/27/Prometheus%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E4%B9%8Bkubernetes-sd-configs/" class="article-date">
  <time datetime="2024-02-27T09:54:52.000Z" itemprop="datePublished">2024-02-27</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Prometheus/">Prometheus</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">4.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">19 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、服务发现概述"><a href="#一、服务发现概述" class="headerlink" title="一、服务发现概述"></a>一、服务发现概述</h2><h3 id="1-为什么要使用服务发现"><a href="#1-为什么要使用服务发现" class="headerlink" title="1. 为什么要使用服务发现"></a>1. 为什么要使用服务发现</h3><p>通常我们的Kubernetes 集群中会有很多的 Service 和 Pod等资源，这些资源可以随着需求规模的变化而变化，而这些pod的ip，名称也并非一成不变的。那么当k8s资源创建或更新时，如果一个一个的去更改或创建对应的监控Job，那操作将会非常的繁琐。而prometheus的自动发现功能，便轻松的解决了上述问题。</p>
<h3 id="2-什么是服务发现"><a href="#2-什么是服务发现" class="headerlink" title="2. 什么是服务发现"></a>2. 什么是服务发现</h3><p>对于上述问题，Prometheus这一类基于Pull模式的监控系统，很显然也无法继续使用的static_configs的方式静态的定义监控目标。而Prometheus的解决方案就是引入一个中间的代理人（服务注册中心），这个代理人掌握着当前所有监控目标的访问信息，Prometheus只需要向这个代理人询问有哪些监控目标即可，Prometheus查询到需要监控的Target列表，然后轮训这些Target获取监控数据，这种模式被称为服务发现。<br>Prometheus支持多种服务发现机制：文件、DNS、Consul、Kubernetes、OpenStack、EC2等。本文以Kubernetes服务发现机制为例，详细探究。<br>在Kubernetes下，Prometheus 通过与 Kubernetes API 集成主要支持5种服务发现模式：Node、Service、Pod、Endpoints、Ingress。不同的服务发现模式适用于不同的场景，例如：node适用于与主机相关的监控资源，如节点中运行的Kubernetes 组件状态、节点上运行的容器状态等；service 和 ingress 适用于通过黑盒监控的场景，如对服务的可用性以及服务质量的监控；endpoints 和 pod 均可用于获取 Pod 实例的监控数据，如监控用户或者管理员部署的支持 Prometheus 的应用。</p>
<h2 id="二、配置文件分析"><a href="#二、配置文件分析" class="headerlink" title="二、配置文件分析"></a>二、配置文件分析</h2><h3 id="1-配置文件编写流程"><a href="#1-配置文件编写流程" class="headerlink" title="1. 配置文件编写流程"></a>1. 配置文件编写流程</h3><p>prometheus自动发现的核心之处在于relabel_configs的相关配置，首先是通过source_labels配置以__meta_开头的这些元数据标签，声明要匹配的资源，然后通过regex匹配规则找到相关的资源对象，最后再对采集过来的指标做二次处理，比如保留、过来、替换等操作。</p>
<h3 id="2-配置文件示例"><a href="#2-配置文件示例" class="headerlink" title="2. 配置文件示例"></a>2. 配置文件示例</h3><blockquote>
<p>此处以prometheus服务为例，标签为app&#x3D;prometheus</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # 间隔时间</span><br><span class="line">  scrape_interval: 30s</span><br><span class="line">  # 超时时间</span><br><span class="line">  scrape_timeout: 10s</span><br><span class="line">  # 另一个独立的规则周期，对告警规则做定期计算</span><br><span class="line">  evaluation_interval: 30s</span><br><span class="line">  # 外部系统标签用于区分prometheus服务实例</span><br><span class="line">  external_labels:</span><br><span class="line">    prometheus: monitoring/k8s</span><br><span class="line">    prometheus_replica: prometheus-k8s-1</span><br><span class="line">scrape_configs: </span><br><span class="line">  # 定义job名称，一个能够被抓取监控数据的endpoint叫做Instance，有着同样目的的Instance集合叫做Job。</span><br><span class="line">- job_name: &quot;prometheus&quot;</span><br><span class="line">  # Honor_labels 控制 Prometheus 如何处理已存在于抓取数据中的标签与 Prometheus 将在服务器端附加的标签（“作业”和“实例”标签、手动配置的目标标签以及由服务发现实现生成的标签）之间的冲突。</span><br><span class="line">  # 如果honor_labels 设置为“true”，标签冲突通过从抓取的数据中保留标签值并忽略冲突的服务器端标签来解决。</span><br><span class="line">  # 如果 Honor_labels 设置为“false”，则通过将抓取数据中的冲突标签重命名为“exported_&lt;original-label&gt;”来解决标签冲突（</span><br><span class="line">  # 将 Honor_labels 设置为“true”对于联邦和抓取 Pushgateway 等用例很有用，其中应保留目标中指定的所有标签。</span><br><span class="line">  honor_labels: true  </span><br><span class="line">  # Honor_timestamps是否采用抓取数据中存在的时间戳默认为true。设置为“true”，则将使用目标公开的指标的时间戳。设置为“false”，则目标公开的指标的时间戳将被忽略。</span><br><span class="line">  honor_timestamps: true</span><br><span class="line">  # 抓取目标的频率</span><br><span class="line">  scrape_interval: 30s</span><br><span class="line">  # 抓取请求超时的时间</span><br><span class="line">  scrape_timeout: 10s</span><br><span class="line">  # 配置抓取请求的 TLS 设置。（https协议时需要填写证书等相关配置）</span><br><span class="line">  #tls_config:</span><br><span class="line">  #  [ &lt;tls_config&gt; ]</span><br><span class="line">  # bearer_token_file</span><br><span class="line">  # 使用配置的承载令牌在每个scrape请求上设置`Authorization`标头。 它`bearer_token_file`和是互斥的。</span><br><span class="line">  #[ bearer_token: &lt;secret&gt; ]</span><br><span class="line">  # 使用配置的承载令牌在每个scrape请求上设置`Authorization`标头。 它`bearer_token`和是互斥的。</span><br><span class="line">  # [ bearer_token_file: /path/to/bearer/token/file ]</span><br><span class="line">  # 从目标获取指标的资源路径，默认为/metrics</span><br><span class="line">  metrics_path: /metrics</span><br><span class="line">  # 配置请求使用的协议方案，默认为http</span><br><span class="line">  scheme: http</span><br><span class="line">  # 基于kubernetes的API server实现自动发现</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  # 角色为 endpoints，通过service来发现后端endpoints，每一个service都有对应的endpoints，如果满足采集条件，那么在service、POD中定义的labels也会被采集进去</span><br><span class="line">  - role: endpoints</span><br><span class="line">  # 标签匹配处理相关配置</span><br><span class="line">  relabel_configs:</span><br><span class="line">    # 以prometheus服务为例，他的service标签为app=prometheus。因此source_labels选择__meta_kubernetes_service_label_app，他会列出k8s所有服务对象的标签，其他常用的元数据标签如下</span><br><span class="line">    # 节点node</span><br><span class="line">    # __meta_kubernetes_node_name: 节点对象的名称</span><br><span class="line">    # __meta_kubernetes_node_label_&lt;labelname&gt;: 节点对象的每个标签</span><br><span class="line">    # __meta_kubernetes_node_address_&lt;address_type&gt;: 如果存在，每一个节点对象类型的第一个地址</span><br><span class="line">    # 服务service</span><br><span class="line">    # __meta_kubernetes_namespace: 服务对象的命名空间</span><br><span class="line">    # __meta_kubernetes_service_cluster_ip: 服务的群集IP地址。（不适用于ExternalName类型的服务）</span><br><span class="line">    # __meta_kubernetes_service_external_name: 服务的DNS名称。（适用于ExternalName类型的服务）</span><br><span class="line">    # __meta_kubernetes_service_label_&lt;labelname&gt;: 服务对象的标签。</span><br><span class="line">    # __meta_kubernetes_service_name: 服务对象的名称</span><br><span class="line">    # __meta_kubernetes_service_port_name: 目标服务端口的名称</span><br><span class="line">    # __meta_kubernetes_service_port_protocol: 目标服务端口的协议</span><br><span class="line">    # __meta_kubernetes_service_type: 服务的类型</span><br><span class="line">    # pod</span><br><span class="line">    # __meta_kubernetes_namespace: pod对象的命名空间</span><br><span class="line">    # __meta_kubernetes_pod_name: pod对象的名称</span><br><span class="line">    # __meta_kubernetes_pod_ip: pod对象的IP地址</span><br><span class="line">    # __meta_kubernetes_pod_label_&lt;labelname&gt;: pod对象的标签</span><br><span class="line">    # __meta_kubernetes_pod_container_name: 目标地址的容器名称</span><br><span class="line">    # __meta_kubernetes_pod_container_port_name: 容器端口名称</span><br><span class="line">    # __meta_kubernetes_pod_ready: 设置pod ready状态为true或者false</span><br><span class="line">    # __meta_kubernetes_pod_phase: 在生命周期中设置 Pending, Running, Succeeded, Failed 或 Unknown</span><br><span class="line">    # __meta_kubernetes_pod_node_name: pod调度的node名称</span><br><span class="line">    # __meta_kubernetes_pod_host_ip: 节点对象的主机IP</span><br><span class="line">    # __meta_kubernetes_pod_uid: pod对象的UID。</span><br><span class="line">    # __meta_kubernetes_pod_controller_kind: pod控制器的kind对象.</span><br><span class="line">    # __meta_kubernetes_pod_controller_name: pod控制器的名称.</span><br><span class="line">    # 端点endpoints</span><br><span class="line">    # __meta_kubernetes_namespace: 端点对象的命名空间</span><br><span class="line">    # __meta_kubernetes_endpoints_name: 端点对象的名称</span><br><span class="line">    # __meta_kubernetes_endpoint_hostname: 端点的Hostname</span><br><span class="line">    # __meta_kubernetes_endpoint_node_name: 端点所在节点的名称。</span><br><span class="line">    # __meta_kubernetes_endpoint_ready: endpoint ready状态设置为true或者false。</span><br><span class="line">    # __meta_kubernetes_endpoint_port_name: 端点的端口名称</span><br><span class="line">    # __meta_kubernetes_endpoint_port_protocol: 端点的端口协议</span><br><span class="line">    # __meta_kubernetes_endpoint_address_target_kind: 端点地址目标的kind。</span><br><span class="line">    # __meta_kubernetes_endpoint_address_target_name: 端点地址目标的名称。</span><br><span class="line">    # ingress</span><br><span class="line">    # __meta_kubernetes_namespace: ingress对象的命名空间</span><br><span class="line">    # __meta_kubernetes_ingress_name: ingress对象的名称</span><br><span class="line">    # __meta_kubernetes_ingress_label_&lt;labelname&gt;: ingress对象的每个label。</span><br><span class="line">    # __meta_kubernetes_ingress_scheme: 协议方案，如果设置了TLS配置，则为https。默认为http。</span><br><span class="line">    # __meta_kubernetes_ingress_path: ingree spec的路径。默认为/。</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_label_app]</span><br><span class="line">      # 通过正式表达式匹配，条件为service的label标签app=prometheus的资源</span><br><span class="line">      regex: prometheus</span><br><span class="line">      # 执行动作 </span><br><span class="line">      # keep：仅收集匹配到regex的源标签，而会丢弃没有匹配到的所有标签，用于选择</span><br><span class="line">      # replace：默认行为，不配置action的话就采用这种行为，它会根据regex来去匹配source_labels标签上的值，并将并将匹配到的值写入target_label中</span><br><span class="line">      # labelmap：它会根据regex去匹配标签名称，并将匹配到的内容作为新标签的名称，其值作为新标签的值</span><br><span class="line">      # drop：丢弃匹配到regex的源标签，而会收集没有匹配到的所有标签，用于排除</span><br><span class="line">      # labeldrop：使用regex匹配标签，符合regex规则的标签将从target实例中移除，其实也就是不收集不保存</span><br><span class="line">      # labelkeep：使用regex匹配标签，仅收集符合regex规则的标签，不符合的不收集</span><br><span class="line">      action: keep</span><br><span class="line">    # 添加服务对象的名称空间信息，并替换标签名为namespace</span><br><span class="line">    - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">      action: replace</span><br><span class="line">      target_label: namespace</span><br><span class="line">    # 添加对象的名称信息，并替换为name</span><br><span class="line">    - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">      action: replace</span><br><span class="line">      target_label: name</span><br><span class="line">    # 添加pod对象的名称信息，并替换为pod</span><br><span class="line">    - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">      action: replace</span><br><span class="line">      target_label: pod</span><br></pre></td></tr></table></figure>

<h2 id="三、具体实现步骤"><a href="#三、具体实现步骤" class="headerlink" title="三、具体实现步骤"></a>三、具体实现步骤</h2><blockquote>
<p>通过部署prometheus服务相关资源，具体说明在实际使用中如何配置prometheus的自动发现</p>
</blockquote>
<h3 id="1-创建ServiceAccount并为其绑定RBAC权限"><a href="#1-创建ServiceAccount并为其绑定RBAC权限" class="headerlink" title="1. 创建ServiceAccount并为其绑定RBAC权限"></a>1. 创建ServiceAccount并为其绑定RBAC权限</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# cat rbac.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;configmaps&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">- nonResourceURLs: [&quot;/metrics&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: prometheus</span><br><span class="line">    namespace: monitoring</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">[root@tiaoban prometheus]# kubectl apply -f rbac.yaml </span><br><span class="line">namespace/monitoring created</span><br><span class="line">serviceaccount/prometheus created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br></pre></td></tr></table></figure>

<h3 id="2-创建configmap"><a href="#2-创建configmap" class="headerlink" title="2. 创建configmap"></a>2. 创建configmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# cat prometheus-config.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  prometheus.yaml: |-</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 5s</span><br><span class="line">      evaluation_interval: 5s</span><br><span class="line">      external_labels:</span><br><span class="line">        cluster: prometheus-1</span><br><span class="line">    rule_files:</span><br><span class="line">    - /etc/prometheus/rules/*.yaml</span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: prometheus</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_label_app]</span><br><span class="line">        regex: prometheus</span><br><span class="line">        action: keep</span><br><span class="line">      - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: endpoint</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: pod</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: service</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: namespace</span><br><span class="line">[root@tiaoban prometheus]# kubectl apply -f prometheus-config.yaml </span><br><span class="line">configmap/prometheus-config created</span><br></pre></td></tr></table></figure>

<h3 id="3-创建prometheus"><a href="#3-创建prometheus" class="headerlink" title="3. 创建prometheus"></a>3. 创建prometheus</h3><blockquote>
<p>因为prometheus是有状态服务，因此创建StatefulSet控制器，存储使用local pv。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# cat prometheus.yaml </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-headless</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 9090</span><br><span class="line">    targetPort: web</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  serviceName: prometheus-headless</span><br><span class="line">  podManagementPolicy: Parallel</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus</span><br><span class="line">        image: prom/prometheus:v2.30.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/etc/prometheus/config/prometheus.yaml</span><br><span class="line">        - --storage.tsdb.path=/prometheus</span><br><span class="line">        - --storage.tsdb.retention.time=10d</span><br><span class="line">        - --web.route-prefix=/</span><br><span class="line">        - --web.enable-lifecycle</span><br><span class="line">        - --storage.tsdb.no-lockfile</span><br><span class="line">        - --storage.tsdb.min-block-duration=2h</span><br><span class="line">        - --storage.tsdb.max-block-duration=2h</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/healthy</span><br><span class="line">            port: web</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/ready</span><br><span class="line">            port: web</span><br><span class="line">            scheme: HTTP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/prometheus/config</span><br><span class="line">          name: prometheus-config</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /prometheus</span><br><span class="line">          name: data</span><br><span class="line">      volumes:</span><br><span class="line">      - name: prometheus-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-config</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: data</span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteOnce</span><br><span class="line">      storageClassName: local-storage</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 10Gi</span><br><span class="line">[root@tiaoban prometheus]# kubectl apply -f prometheus.yaml </span><br><span class="line">service/prometheus-headless created</span><br><span class="line">statefulset.apps/prometheus created</span><br></pre></td></tr></table></figure>

<h3 id="4-创建ingress"><a href="#4-创建ingress" class="headerlink" title="4. 创建ingress"></a>4. 创建ingress</h3><blockquote>
<p>此处以traefik举例说明</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# cat prometheus-ingress.yaml </span><br><span class="line">apiVersion: traefik.containo.us/v1alpha1</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  routes:</span><br><span class="line">    - match: Host(`prometheus.local.com`)</span><br><span class="line">      kind: Rule</span><br><span class="line">      services:</span><br><span class="line">        - name: prometheus-headless</span><br><span class="line">          port: 9090</span><br><span class="line">[root@tiaoban prometheus]# kubectl apply -f prometheus-ingress.yaml </span><br><span class="line">ingressroute.traefik.containo.us/prometheus created</span><br></pre></td></tr></table></figure>

<h3 id="5-访问验证"><a href="#5-访问验证" class="headerlink" title="5. 访问验证"></a>5. 访问验证</h3><blockquote>
<p>修改本地hosts文件后访问验证</p>
</blockquote>
<p><img src="/images/1709027620-0b7d5ac7b2bd95e235fbae19bc9d465e.jpg" alt="image.png"></p>
<h2 id="四、常见job配置示例"><a href="#四、常见job配置示例" class="headerlink" title="四、常见job配置示例"></a>四、常见job配置示例</h2><h3 id="1-apiserver"><a href="#1-apiserver" class="headerlink" title="1. apiserver"></a>1. apiserver</h3><ul>
<li>查看apiserver服务信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe svc kubernetes </span><br><span class="line">Name:              kubernetes</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.1</span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         192.168.10.10:6443</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据svc信息可知，apiserver位于default命名空间下，标签为component&#x3D;apiserver，访问方式为https，端口为6443</p>
</blockquote>
<ul>
<li>编写prometheus配置文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- job_name: kube-apiserver</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: default;kubernetes</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: service</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是使用https访问时，需要tls相关配置，可以指定ca证书路径或者insecure_skip_verify: true跳过证书验证。除此之外，还要指定bearer_token_file，否则会提示server returned HTTP status 400 Bad Request</p>
</blockquote>
<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-65b5229c1805f4737ce5f4f884ceccdb.jpg" alt="image.png"></p>
<h3 id="2-controller-manager"><a href="#2-controller-manager" class="headerlink" title="2. controller-manager"></a>2. controller-manager</h3><ul>
<li>查看controller-manager信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe pod -n kube-system kube-controller-manager-k8s-master </span><br><span class="line">Name:                 kube-controller-manager-k8s-master</span><br><span class="line">Namespace:            kube-system</span><br><span class="line">……</span><br><span class="line">Labels:               component=kube-controller-manager</span><br><span class="line">                      tier=control-plane</span><br><span class="line">……</span><br><span class="line">Containers:</span><br><span class="line">  kube-controller-manager:</span><br><span class="line">    ……</span><br><span class="line">    Command:</span><br><span class="line">      kube-controller-manager</span><br><span class="line">      --allocate-node-cidrs=true</span><br><span class="line">      --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">      --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span><br><span class="line">      --bind-address=127.0.0.1</span><br><span class="line">      ……</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，匹配pod对象，lable标签为component&#x3D;kube-controller-manager即可，但需注意的是controller-manager默认只运行127.0.0.1访问，因此还需先修改controller-manager配置</p>
</blockquote>
<ul>
<li>修改&#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-controller-manager.yaml</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master manifests]# cat /etc/kubernetes/manifests/kube-controller-manager.yaml </span><br><span class="line">……</span><br><span class="line">  - command:</span><br><span class="line">    - --bind-address=0.0.0.0 # 端口改为0.0.0.0</span><br><span class="line">    #- --port=0 # 注释0端口</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<ul>
<li>编写prometheus配置文件，需要注意的是，他默认匹配到的是80端口，需要手动指定为10252端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- job_name: kube-controller-manager</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_component]</span><br><span class="line">    regex: kube-controller-manager</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10252</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: service</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-d3d70171ce18deedea42a2834acab1e5.jpg" alt="image.png"></p>
<h3 id="3-scheduler"><a href="#3-scheduler" class="headerlink" title="3. scheduler"></a>3. scheduler</h3><ul>
<li>查看scheduler资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe pod -n kube-system kube-scheduler-k8s-master </span><br><span class="line">Name:                 kube-scheduler-k8s-master</span><br><span class="line">Namespace:            kube-system</span><br><span class="line">……</span><br><span class="line">Labels:               component=kube-scheduler</span><br><span class="line">                      tier=control-plane</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，匹配pod对象，lable标签为component&#x3D;kube-scheduler即可scheduler和controller-manager一样，默认监听0端口，需要注释</p>
</blockquote>
<ul>
<li>编写prometheus配置文件，需要注意的是，他默认匹配到的是80端口，需要手动指定为10251端口,同时指定token，否则会提示server returned HTTP status 400 Bad Request</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- job_name: kube-scheduler</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_component]</span><br><span class="line">    regex: kube-scheduler</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10251</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: service</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-3df46332151a0b186d9518efd750d4c7.jpg" alt="image.png"></p>
<h3 id="4-kube-state-metrics"><a href="#4-kube-state-metrics" class="headerlink" title="4. kube-state-metrics"></a>4. kube-state-metrics</h3><ul>
<li>查看scheduler资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe svc -n kube-system kube-state-metrics </span><br><span class="line">Name:              kube-state-metrics</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            app.kubernetes.io/component=exporter</span><br><span class="line">                   app.kubernetes.io/name=kube-state-metrics</span><br><span class="line">                   app.kubernetes.io/version=2.2.1</span><br><span class="line">Annotations:       Selector:  app.kubernetes.io/name=kube-state-metrics</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                None</span><br><span class="line">Port:              http-metrics  8080/TCP</span><br><span class="line">TargetPort:        http-metrics/TCP</span><br><span class="line">Endpoints:         10.244.1.47:8080</span><br><span class="line">Port:              telemetry  8081/TCP</span><br><span class="line">TargetPort:        telemetry/TCP</span><br><span class="line">Endpoints:         10.244.1.47:8081</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，匹配svc对象，name为kube-state-metrics即可</p>
</blockquote>
<ul>
<li>编写prometheus配置文件，需要注意的是，他默认匹配到的是8080和801两个端口，需要手动指定为8080端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- job_name: kube-state-metrics</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    regex: kube-state-metrics</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:8080</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: service</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-ce0cc1b6744a77d9b5c864cdd07ac386.jpg" alt="image.png"></p>
<h3 id="5-kubelet"><a href="#5-kubelet" class="headerlink" title="5. kubelet"></a>5. kubelet</h3><ul>
<li>查看kubelet资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-work2 ~]# ss -tunlp | grep kubelet</span><br><span class="line">tcp     LISTEN   0        128            127.0.0.1:42735          0.0.0.0:*      users:((&quot;kubelet&quot;,pid=1064,fd=12))                                             </span><br><span class="line">tcp     LISTEN   0        128            127.0.0.1:10248          0.0.0.0:*      users:((&quot;kubelet&quot;,pid=1064,fd=29))                                             </span><br><span class="line">tcp     LISTEN   0        128                    *:10250                *:*      users:((&quot;kubelet&quot;,pid=1064,fd=30))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，kubelet在每个node节点都有运行，端口为10250，因此role使用node即可。</p>
</blockquote>
<ul>
<li>编写prometheus配置文件，需要注意的是，他的指标采集地址为&#x2F;metrics&#x2F;cadvisor，需要配置https访问，可以设置insecure_skip_verify: true跳过证书验证</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: kubelet</span><br><span class="line">  metrics_path: /metrics/cadvisor</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    insecure_skip_verify: true</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-689a42f2211a8ca7d590340ea4178b41.jpg" alt="image.png"></p>
<h3 id="6-node-exporter"><a href="#6-node-exporter" class="headerlink" title="6. node_exporter"></a>6. node_exporter</h3><ul>
<li>查看scheduler资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe pod -n monitoring node-exporter-9dsqr </span><br><span class="line">Name:         node-exporter-9dsqr</span><br><span class="line">Namespace:    monitoring</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         k8s-master/192.168.10.10</span><br><span class="line">Start Time:   Sun, 17 Oct 2021 16:42:24 +0800</span><br><span class="line">Labels:       app=node-exporter</span><br><span class="line">              controller-revision-hash=775f546bd4</span><br><span class="line">              pod-template-generation=1</span><br><span class="line">……</span><br><span class="line">    Port:          9100/TCP</span><br><span class="line">    Host Port:     9100/TCP</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<blockquote>
<p>node_exporter也是每个node节点都运行，因此role使用node即可，默认address端口为10250，替换为9100即可</p>
</blockquote>
<ul>
<li>编写prometheus配置文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- job_name: node_exporter</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__address__]</span><br><span class="line">    regex: &#x27;(.*):10250&#x27;</span><br><span class="line">    replacement: &#x27;$&#123;1&#125;:9100&#x27;</span><br><span class="line">    target_label: __address__</span><br><span class="line">    action: replace</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-c705fd92ad8e11f8f4dd2174a620c492.jpg" alt="image.png"></p>
<h3 id="7-coredns"><a href="#7-coredns" class="headerlink" title="7. coredns"></a>7. coredns</h3><ul>
<li>查看coredns资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe svc -n kube-system kube-dns </span><br><span class="line">Name:              kube-dns</span><br><span class="line">Namespace:         kube-system</span><br><span class="line">Labels:            k8s-app=kube-dns</span><br><span class="line">                   kubernetes.io/cluster-service=true</span><br><span class="line">                   kubernetes.io/name=KubeDNS</span><br><span class="line">Annotations:       prometheus.io/port: 9153</span><br><span class="line">                   prometheus.io/scrape: true</span><br><span class="line">Selector:          k8s-app=kube-dns</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         10.244.1.44:53,10.244.2.36:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         10.244.1.44:53,10.244.2.36:53</span><br><span class="line">Port:              metrics  9153/TCP</span><br><span class="line">TargetPort:        9153/TCP</span><br><span class="line">Endpoints:         10.244.1.44:9153,10.244.2.36:9153</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，匹配pod对象，lable标签为component&#x3D;kube-scheduler即可</p>
</blockquote>
<ul>
<li>编写prometheus配置文件，需要注意的是，他默认匹配到的是53端口，需要手动指定为9153端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- job_name: coredns</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels:</span><br><span class="line">      - __meta_kubernetes_service_label_k8s_app</span><br><span class="line">    regex: kube-dns</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:9153</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: service</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-8a214fdcf946aef0c89ad3fc5516f3a3.jpg" alt="image.png"></p>
<h3 id="8-etcd"><a href="#8-etcd" class="headerlink" title="8. etcd"></a>8. etcd</h3><ul>
<li>查看scheduler资源详情</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@tiaoban prometheus]# kubectl describe pod -n kube-system etcd-k8s-master </span><br><span class="line">Name:                 etcd-k8s-master</span><br><span class="line">Namespace:            kube-system</span><br><span class="line">Priority:             2000001000</span><br><span class="line">Priority Class Name:  system-node-critical</span><br><span class="line">Node:                 k8s-master/192.168.10.10</span><br><span class="line">Start Time:           Sun, 17 Oct 2021 12:31:51 +0800</span><br><span class="line">Labels:               component=etcd</span><br><span class="line">                      tier=control-plane</span><br><span class="line">……</span><br><span class="line">    Command:</span><br><span class="line">      etcd</span><br><span class="line">      --advertise-client-urls=https://192.168.10.10:2379</span><br><span class="line">      --cert-file=/etc/kubernetes/pki/etcd/server.crt</span><br><span class="line">      --client-cert-auth=true</span><br><span class="line">      --data-dir=/var/lib/etcd</span><br><span class="line">      --initial-advertise-peer-urls=https://192.168.10.10:2380</span><br><span class="line">      --initial-cluster=k8s-master=https://192.168.10.10:2380</span><br><span class="line">      --key-file=/etc/kubernetes/pki/etcd/server.key</span><br><span class="line">      --listen-client-urls=https://127.0.0.1:2379,https://192.168.10.10:2379</span><br><span class="line">      --listen-metrics-urls=http://127.0.0.1:2381</span><br><span class="line">      --listen-peer-urls=https://192.168.10.10:2380</span><br><span class="line">      --name=k8s-master</span><br><span class="line">      --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span><br><span class="line">      --peer-client-cert-auth=true</span><br><span class="line">      --peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span><br><span class="line">      --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">      --snapshot-count=10000</span><br><span class="line">      --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由上可知，启动参数里面有一个 –listen-metrics-urls&#x3D;<a target="_blank" rel="noopener" href="http://127.0.0.1:2381/">http://127.0.0.1:2381</a> 的配置，该参数就是来指定 Metrics 接口运行在 2381 端口下面的，而且是 http 的协议，所以也不需要什么证书配置，这就比以前的版本要简单许多了，以前的版本需要用 https 协议访问，所以要配置对应的证书。但是还需修改配置文件，地址改为0.0.0.0</p>
</blockquote>
<ul>
<li>编写prometheus配置文件，需要注意的是，他默认匹配到的是2379端口，需要手动指定为2381端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- job_name: etcd</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels:</span><br><span class="line">      - __meta_kubernetes_pod_label_component</span><br><span class="line">    regex: etcd</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_ip]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:2381</span><br><span class="line">  - source_labels: [__meta_kubernetes_endpoints_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: endpoint</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: pod</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: namespace</span><br></pre></td></tr></table></figure>

<ul>
<li>结果查看</li>
</ul>
<p><img src="/images/1709027620-b5a167d26dc1df564aaa5c2cfdfb1987.jpg" alt="image.png"></p>
<blockquote>
<p>参考链接</p>
<ul>
<li>prometheus配置文件说明</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1844101">https://cloud.tencent.com/developer/article/1844101</a></p>
<blockquote>
<ul>
<li>prometheus kubernetes_sd_configs配置官方文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a></li>
</ul>
</blockquote>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2024/02/27/Prometheus%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E4%B9%8Bkubernetes-sd-configs/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/02/28/Grafana%E4%B8%ADElasticSearch%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Grafana中ElasticSearch日志查询使用方法
          
        </div>
      </a>
    
    
      <a href="/2024/02/27/grafana-API%E4%BD%BF%E7%94%A8/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">grafana API使用</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> JinTao Li
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="https://beian.miit.gov.cn/" target="_black" rel="nofollow">鲁ICP备88888888</a>
        </li>
        
    </ul>
    <ul>
      
      <li>
          <img src="/images/beian.png"></img>
          <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=01234567890123" target="_black" rel="nofollow">青岛公安网备01234567890123号</a>
      </li>
        
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Lijintao&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://blog.csdn.net/u013235026">CSDN</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/jintaoli">博客园</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/images/272a163694dd8a415a43dbf85ac34778.jpg">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=2049529248&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    
<script>
  const password = "jintao1210";
  const lock_password = window.sessionStorage.getItem("lock_password");
  console.log(password, lock_password);
  if (lock_password !== password) {
    Swal.fire({
      title: "请输入访问密码",
      input: "text",
      inputAttributes: {
        autocapitalize: "off",
      },
      showCancelButton: false,
      showLoaderOnConfirm: true,
      allowOutsideClick: false,
      confirmButtonText: "确定",
    }).then((result) => {
      console.log(result);
      if (result.isConfirmed) {
        console.log(password);
        if (result.value === password) {
          window.sessionStorage.setItem("lock_password", result.value);
        } else {
          Swal.fire({
            icon: "error",
            title: "密码错误，请重试",
            confirmButtonText: "确定",
            allowOutsideClick: false,
          }).then(() => {
            window.location.reload();
          });
        }
      }
    });
  }
</script>


  </div>
</body>

</html>