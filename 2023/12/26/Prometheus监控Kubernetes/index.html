<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="博客" />
       
      <meta name="description" content="日常随笔" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Prometheus监控Kubernetes |  Lijintao&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="alternate" href="/atom.xml" title="Lijintao's Blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="Prometheus-Prometheus监控Kubernetes"
  class="article article-type-Prometheus"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Prometheus监控Kubernetes
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/12/26/Prometheus%E7%9B%91%E6%8E%A7Kubernetes/" class="article-date">
  <time datetime="2023-12-26T09:48:51.000Z" itemprop="datePublished">2023-12-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Prometheus/">Prometheus</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">10.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">46 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、kubernetes-sd-config（虽然是翻译官网但是别忽略好好看一看）"><a href="#一、kubernetes-sd-config（虽然是翻译官网但是别忽略好好看一看）" class="headerlink" title="一、kubernetes_sd_config（虽然是翻译官网但是别忽略好好看一看）"></a>一、kubernetes_sd_config（虽然是翻译官网但是别忽略好好看一看）</h2><h3 id="1-1、-单说的配置："><a href="#1-1、-单说的配置：" class="headerlink" title="1.1、 单说&lt;kubernetes_sd_config&gt;的配置："></a>1.1、 单说&lt;kubernetes_sd_config&gt;的配置：</h3><p>     Kubernetes SD配置允许从Kubernetes的REST API检索抓取目标，并始终与集群状态保持同步。可以将以下角色类型之一配置为发现目标：</p>
<p>node</p>
<p>      node角色为每个群集节点发现一个目标，其地址默认为Kubelet的HTTP端口。 目标地址默认为Kubernetes节点对象的第一个现有地址，按照NodeInternalIP，NodeExternalIP，NodeLegacyHostIP和NodeHostName的地址类型顺序。可用的元标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__meta_kubernetes_node_name: node对象的名称。</span><br><span class="line">__meta_kubernetes_node_label_&lt;labelname&gt;: 来自节点对象的每个标签。</span><br><span class="line">__meta_kubernetes_node_labelpresent_&lt;labelname&gt;: 对于节点对象中的每个标签，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_node_annotation_&lt;annotationname&gt;: 来自节点对象的每个注释。</span><br><span class="line">__meta_kubernetes_node_annotationpresent_&lt;annotationname&gt;: 对于来自节点对象的每个注释，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_node_address_&lt;address_type&gt;: 每个节点地址类型的第一个地址（如果存在）。</span><br></pre></td></tr></table></figure>

<p>      此外，该节点的实例标签将设置为从API服务器检索到的节点名称。  </p>
<p>service </p>
<p>      service角色发现每个服务的每个服务端口的目标。 这通常用于监视服务的黑盒。 该地址将设置为服务的Kubernetes DNS名称以及相应的服务端口。可用的元标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__meta_kubernetes_namespace: service对象的名称空间。</span><br><span class="line">__meta_kubernetes_service_annotation_&lt;annotationname&gt;: 来自service对象的每个注释。</span><br><span class="line">__meta_kubernetes_service_annotationpresent_&lt;annotationname&gt;: service对象的每个注释为“ <span class="literal">true</span>”。</span><br><span class="line">__meta_kubernetes_service_cluster_ip: service的群集IP地址。（不适用于外部名称类型的服务）</span><br><span class="line">__meta_kubernetes_service_external_name: service的DNS名称。（适用于外部名称类型的服务）</span><br><span class="line">__meta_kubernetes_service_label_&lt;labelname&gt;: service对象中的每个标签。</span><br><span class="line">__meta_kubernetes_service_labelpresent_&lt;labelname&gt;: 对于service对象的每个标签为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_service_name: service对象的名称。</span><br><span class="line">__meta_kubernetes_service_port_name: service服务端口的名称。</span><br><span class="line">__meta_kubernetes_service_port_protocol: 目标service端口的协议。</span><br></pre></td></tr></table></figure>

<p>pod</p>
<p>       容器角色发现所有容器并将其容器公开为目标。 对于容器的每个声明的端口，将生成一个目标。 如果容器没有指定的端口，则会为每个容器创建无端口目标，以通过重新标记手动添加端口。可用的元标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__meta_kubernetes_namespace: pod对象的名称空间。</span><br><span class="line">__meta_kubernetes_pod_name: 容器对象的名称。</span><br><span class="line">__meta_kubernetes_pod_ip: 容器对象的容器IP。</span><br><span class="line">__meta_kubernetes_pod_label_&lt;labelname&gt;: 来自pod对象的每个标签。</span><br><span class="line">__meta_kubernetes_pod_labelpresent_&lt;labelname&gt;: 对于来自pod对象的每个标签，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_pod_annotation_&lt;annotationname&gt;: 来自pod对象的每个注释。</span><br><span class="line">__meta_kubernetes_pod_annotationpresent_&lt;annotationname&gt;: 对于Pod对象中的每个注释，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_pod_container_init: 如果容器是InitContainer，则为<span class="literal">true</span></span><br><span class="line">__meta_kubernetes_pod_container_name: 目标地址指向的容器的名称。</span><br><span class="line">__meta_kubernetes_pod_container_port_name: 容器端口的名称。</span><br><span class="line">__meta_kubernetes_pod_container_port_number: 容器端口号。</span><br><span class="line">__meta_kubernetes_pod_container_port_protocol: 容器端口的协议。</span><br><span class="line">__meta_kubernetes_pod_ready:  为Pod的就绪状态设置为<span class="literal">true</span>或<span class="literal">false</span>。</span><br><span class="line">__meta_kubernetes_pod_phase: 在生命周期中设置为Pending, Running, Succeeded, Failed or Unknown。</span><br><span class="line">__meta_kubernetes_pod_node_name: Pod调度到的节点的名称</span><br><span class="line">__meta_kubernetes_pod_host_ip: Pod对象的当前主机IP。</span><br><span class="line">__meta_kubernetes_pod_uid: Pod对象的UID。</span><br><span class="line">__meta_kubernetes_pod_controller_kind: Pod控制器的对象种类。</span><br><span class="line">__meta_kubernetes_pod_controller_name: Pod控制器的名称。</span><br></pre></td></tr></table></figure>

<p>endpoints  </p>
<p>      端点角色从列出的服务端点中发现目标。 对于每个端点地址，每个端口都发现一个目标。 如果端点由Pod支持，则该Pod的所有其他未绑定到端点端口的容器端口也将被发现为目标。可用的元标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__meta_kubernetes_namespace: endpoints 对象的名称空间。</span><br><span class="line">__meta_kubernetes_endpoints_name: 端点对象的名称</span><br><span class="line">对于直接从端点列表中发现的所有目标（未从基础容器额外推断出的所有目标），将附加以下标签：</span><br><span class="line">    __meta_kubernetes_endpoint_hostname: 端点的主机名。</span><br><span class="line">    __meta_kubernetes_endpoint_node_name: hosting端点的节点的名称。</span><br><span class="line">    __meta_kubernetes_endpoint_ready: 为端点的就绪状态设置为<span class="literal">true</span>或<span class="literal">false</span>。</span><br><span class="line">    __meta_kubernetes_endpoint_port_name: 端点端口的名称。</span><br><span class="line">    __meta_kubernetes_endpoint_port_protocol: 端点端口的协议。</span><br><span class="line">    __meta_kubernetes_endpoint_address_target_kind: 端点地址目标的种类。</span><br><span class="line">    __meta_kubernetes_endpoint_address_target_name: 端点地址目标的名称。</span><br><span class="line">如果端点属于服务，则会附加角色：服务发现的所有标签。对于由容器支持的所有目标，将附加角色的所有标签：pod discovery。</span><br></pre></td></tr></table></figure>

<p>ingress</p>
<p>     ingress角色发现每个入口的每个路径的目标。 这通常对黑盒监视入口很有用。 该地址将设置为入口规范中指定的主机。可用的元标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__meta_kubernetes_namespace: ingress对象的名称空间。</span><br><span class="line">__meta_kubernetes_ingress_name: ingress对象的名称。</span><br><span class="line">__meta_kubernetes_ingress_label_&lt;labelname&gt;: 来自ingress对象的每个标签。</span><br><span class="line">__meta_kubernetes_ingress_labelpresent_&lt;labelname&gt;: 对于来自ingress对象的每个标签，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_ingress_annotation_&lt;annotationname&gt;: 来自ingress对象的每个注释。</span><br><span class="line">__meta_kubernetes_ingress_annotationpresent_&lt;annotationname&gt;: 对于来自ingress对象的每个注释，为<span class="literal">true</span>。</span><br><span class="line">__meta_kubernetes_ingress_scheme: 入口的协议方案，如果设置了TLS配置，则为https。 默认为http。</span><br><span class="line">__meta_kubernetes_ingress_path: 入口规范的路径。 默认为/。</span><br></pre></td></tr></table></figure>

<p>请参阅以下有关Kubernetes发现的配置选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问Kubernetes API的信息。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#API服务器地址。如果保留为空，则Prometheus被假定为在集群内部运行，并且将自动发现API服务器，并使用Pod的CA证书和承载令牌文件位于/var/run/secrets/kubernetes.io/serviceaccount/。</span></span><br><span class="line">[ api_server: &lt;host&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#应该发现的实体的Kubernetes角色。</span></span><br><span class="line">role: &lt;role&gt;</span><br><span class="line"><span class="comment">#用于向API服务器进行身份验证的可选身份验证信息。请注意，“ basic_auth”，“ bearer_token”和“ bearer_token_file”选项是互斥的。</span></span><br><span class="line"><span class="comment">#password和password_file是互斥的。</span></span><br><span class="line"><span class="comment">#可选的HTTP基本身份验证信息。</span></span><br><span class="line">basic_auth:</span><br><span class="line">  [ username: &lt;string&gt; ]</span><br><span class="line">  [ password: &lt;secret&gt; ]</span><br><span class="line">  [ password_file: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#可选的承载令牌认证信息。</span></span><br><span class="line">[ bearer_token: &lt;secret&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#可选的承载令牌文件认证信息。</span></span><br><span class="line">[ bearer_token_file: &lt;filename&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#可选的代理URL。</span></span><br><span class="line">[ proxy_url: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#TLS配置。</span></span><br><span class="line">tls_config:</span><br><span class="line">  [ &lt;tls_config&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#可选的名称空间发现。 如果省略，则使用所有名称空间。</span></span><br><span class="line">namespaces:</span><br><span class="line">  names:</span><br><span class="line">    [ - &lt;string&gt; ]</span><br></pre></td></tr></table></figure>

<p>其中<role>必须是endpoints, service, pod, node, or ingress。</p>
<p>有关为Kubernetes配置Prometheus的详细示例，请参见此示例Prometheus配置文件：<a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/blob/release-2.13/documentation/examples/prometheus-kubernetes.yml">https://github.com/prometheus/prometheus/blob/release-2.13/documentation/examples/prometheus-kubernetes.yml</a></p>
<p>可能希望查看第三方Prometheus Operator，它可以自动在Kubernetes上设置Prometheus：<a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator">https://github.com/coreos/prometheus-operator</a></p>
<h2 id="二、完整的部署流程"><a href="#二、完整的部署流程" class="headerlink" title="二、完整的部署流程"></a>二、完整的部署流程</h2><h3 id="2-1-Prometheus部署"><a href="#2-1-Prometheus部署" class="headerlink" title="2.1 Prometheus部署"></a>2.1 Prometheus部署</h3><p># kubectl create namespace prometheus</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace/prometheus created</span><br></pre></td></tr></table></figure>

<p>Prometheus:</p>
<p>#vim prometheus-rbac.yaml   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- nonResourceURLs: [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: prometheus</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: prometheus</span><br></pre></td></tr></table></figure>


<p>#prometheus.rbac.yml定义了Prometheus容器访问k8s apiserver所需的ServiceAccount、ClusterRole以及ClusterRoleBinding。</p>
<p>下面是针对上面的配置文件详解：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1   <span class="comment">#指定api版本，此值必须在kubectl apiversion中，RBAC 使用 rbac.authorization.k8s.io API 组来驱动鉴权操作，允许管理员通过 Kubernetes API 动态配置策略。</span></span><br><span class="line">kind: ClusterRole    <span class="comment">#指定创建资源的角色为ClusterRole，ClusterRole对象可以授予整个集群范围内资源访问权限</span></span><br><span class="line">metadata:   <span class="comment">##资源的元数据/属性</span></span><br><span class="line">    <span class="comment"># 此处的 &quot;namespace&quot; 被省略掉是因为 ClusterRoles 是没有命名空间的。</span></span><br><span class="line">  name: prometheus   <span class="comment">#资源的名字，在同一个namespace中必须唯一</span></span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]  <span class="comment"># &quot;&quot; 指定核心 API 组</span></span><br><span class="line"><span class="comment">#ClusterRole 可以授予的权限和 Role 相同，但是因为 ClusterRole 属于集群范围，所以它也可以授予以下访问权限：集群范围资源 （比如 nodes）,非资源端点（比如 “/healthz”）</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]  <span class="comment">#允许读取在“核心”API Group中定义的那些资源</span></span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]  <span class="comment">#允许读取在“extensions”API Group中定义的ingresses</span></span><br><span class="line">- nonResourceURLs: [<span class="string">&quot;/metrics&quot;</span>]  <span class="comment">#允许在非资源端点 “/metrics” 上发起 “GET”请求（必须在 ClusterRole 绑定 ClusterRoleBinding 才生效）</span></span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: prometheus</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:  <span class="comment">#roleRef 里的内容决定了实际创建绑定的方法。kind 可以是 Role 或 ClusterRole，name 将引用你要指定的 Role 或 ClusterRole 的名称</span></span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole   </span><br><span class="line">  name: prometheus   <span class="comment">## 这里的名称必须与你想要绑定的 Role 或 ClusterRole 名称一致</span></span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: prometheus</span><br></pre></td></tr></table></figure>

<p># kubectl create -f  prometheus-rbac.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">serviceaccount/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br></pre></td></tr></table></figure>

<p># vim prometheus-config-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: prometheus</span><br><span class="line">data:</span><br><span class="line">  prometheus.yml: |</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval:     15s</span><br><span class="line">      evaluation_interval: 15s</span><br><span class="line">    scrape_configs:</span><br><span class="line">        <span class="comment">#这里可以很直观的看到是采集apiservers的监控指标的这里采集地址是https://master主机:6443/metrics</span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: default;kubernetes;https</span><br><span class="line">       </span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-nodes&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics</span><br><span class="line"></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics/cadvisor</span><br><span class="line">        </span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __scheme__</span><br><span class="line">        regex: (https?)</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: <span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-services&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-ingresses&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: ingress</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]</span><br><span class="line">        regex: (.+);(.+);(.+)</span><br><span class="line">        replacement: <span class="variable">$&#123;1&#125;</span>://<span class="variable">$&#123;2&#125;</span><span class="variable">$&#123;3&#125;</span></span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_ingress_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_ingress_name]</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line"></span><br><span class="line">    <span class="comment">#这里并非pods的系统监控指标,这里其实是采集的一些特殊的开启了web监听端口提供监控指标的pod    </span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: <span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line">        target_label: __address__</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br></pre></td></tr></table></figure>

<p>#prometheus-config-configmap.yaml定义了prometheus的配置文件，以configmap的形式使用。</p>
<p>#下面是针对上面的一些配置进行的注释说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于发现API SERVER</span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line"><span class="comment">#发现endpoints，它是从列出的服务端点发现目标，这个endpoints来自于Kubernetes中的service，每一个service都有对应的endpoints，</span></span><br><span class="line"><span class="comment">#这里是一个列表可以是一个IP:PORT也可以是多个，这些IP:PORT就是service通过标签选择器选择的POD的IP和端口。</span></span><br><span class="line"><span class="comment">#所以endpoints角色就是用来发现server对应的pod的IP的kubernetes会有一个默认的service，</span></span><br><span class="line"><span class="comment">#通过找到这个service的endpoints就找到了api server的IP:PORT，那endpoints有很多，我怎么知道哪个是api server呢这个就靠source_labels指定的标签名称了。    </span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line"><span class="comment">#通过什么形式来连接，默认是https      </span></span><br><span class="line">      scheme: https</span><br><span class="line"><span class="comment"># 下面这个ca_file和token_file的路径都是默认的，你可能默认设置能用么？其实可以，因为每一个运行起来的POD kubernetes都会为其</span></span><br><span class="line"><span class="comment"># 创建一个serviceaccout的Secret并且挂载到下面的目录上，里面就有ca.crt和token这两个文件，你可以自己启动一个POD，然后通过</span></span><br><span class="line"><span class="comment"># kubectl describe pods 来查看，一定会在Volumes下面有一个default-token-XXX的东西，并且Mounts里面有下面的目录。      </span></span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line"><span class="comment"># 下面的含义是源标签__meta_kubernetes_namespace等如果其值为default;kubernetes;https标签顺序和值要对应。换句话说就是</span></span><br><span class="line"><span class="comment"># 当__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name三者对应的</span></span><br><span class="line"><span class="comment"># 值为default、kubernetes、https则进行保留，而且该endpoints对应的地址为api server的地址。</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># __meta_kubernetes_namespace 端点对象的命名空间，在不同对象上这个标签的含义不同，在角色是endpoints中这个是端点对象的名称空间</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_service_name 端点对象的服务名称</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_endpoint_port_name 端点的端口名称</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># kubernetes默认在default名称空间有一个叫做kubernetes的service，所以这个service的有3个设置对应的就是下面三个标签</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_namespace 值为default</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_service_name 值为kubernetes</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_endpoint_port_name 值为https      </span></span><br><span class="line">      relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: default;kubernetes;https</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置针对kubelet的服务发现以及对标签的处理，是获取kubelet上/metrics接口数据来获取node的资源使用情况        </span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-nodes&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line"><span class="comment"># 使用node角色，它使用默认的kubelet提供的http端口来发现集群中每个node节点。那具体地址是什么呢？</span></span><br><span class="line"><span class="comment"># 地址类型有四种NodeInternalIP, NodeExternalIP, NodeLegacyHostIP 和 NodeHostName，默认为这四个中第一个可用的地址。</span></span><br><span class="line"><span class="comment"># 那么这里为什么使用node角色呢？因为node角色就是用来发现kubelet的</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_node_name：节点对象的名字</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_node_label_&lt;labelname&gt;：表示节点对象上的每一个标签</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_node_annotation_&lt;annotationname&gt;：表示节点对象上的每一个annotation</span></span><br><span class="line"><span class="comment"># __meta_kubernetes_node_address_&lt;address_type&gt;：如果存在，那么将是每一个节点地址类型的第一个地址</span></span><br><span class="line"><span class="comment"># Node模式，Prometheus会自动发现Kubernetes中所有Node节点的信息并作为监控的目标Target。 </span></span><br><span class="line"><span class="comment"># 而这些Target的访问地址实际上就是Kubelet的访问地址，并且Kubelet实际上直接内置了对Promtheus的支持      </span></span><br><span class="line">      - role: node</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line"><span class="comment"># 保留(.+)匹配到的内容，去掉__meta_kubernetes_node_label_，实际上就是把(.+)当做新标签，然后老标签的值给这个新标签，</span></span><br><span class="line"><span class="comment"># 这里没有设置source_labels，则表示匹配所有标签      </span></span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line"><span class="comment">#下面就是将replacement: 中的值kubernetes.default.svc:443赋予给__address__标签</span></span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: kubernetes.default.svc:443</span><br><span class="line"><span class="comment">#下面就是将__meta_kubernetes_node_name的值变成$&#123;1&#125;的形式传给replacement:中的$1，然后赋给标签__metrics_path__   </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">        regex: (.+)</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        replacement: /api/v1/nodes/<span class="variable">$&#123;1&#125;</span>/proxy/metrics  </span><br><span class="line"></span><br><span class="line"><span class="comment">#抓取服务端点，整个这个任务都是用来发现node-exporter和kube-state-metrics-service的，这里用的是endpoints角色，</span></span><br><span class="line"><span class="comment">#这是通过这两者的service来发现的后端endpoints。另外需要说明的是如果满足采集条件，那么在service、POD中定义的labels也会被采集进去        </span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line"><span class="comment"># 重新打标仅抓取到的具有 &quot;prometheus.io/scrape: true&quot; 的annotation的端点，意思是说如果某个service具有prometheus.io/scrape = true annotation声明则抓取</span></span><br><span class="line"><span class="comment"># annotation本身也是键值结构，所以这里的源标签设置为键，而regex设置值，当值匹配到regex设定的内容时则执行keep动作也就是保留，其余则丢弃.</span></span><br><span class="line"><span class="comment"># node-exporter这个POD的service里面就有一个叫做prometheus.io/scrape = true的annotations所以就找到了node-exporter这个POD    </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line"><span class="comment">#重新设置scheme匹配源标签__meta_kubernetes_service_annotation_prometheus_io_scheme也就是prometheus.io/scheme annotation</span></span><br><span class="line"><span class="comment"># 如果源标签的值匹配到regex则把值替换为__scheme__对应的值        </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __scheme__</span><br><span class="line">        regex: (https?)</span><br><span class="line"><span class="comment"># 应用中自定义暴露的指标，也许你暴露的API接口不是/metrics这个路径，那么你可以在这个POD对应的service中做一个</span></span><br><span class="line"><span class="comment"># &quot;prometheus.io/path = /mymetrics&quot; 声明，下面的意思就是把你声明的这个路径赋值给__metrics_path__</span></span><br><span class="line"><span class="comment"># 其实就是让prometheus来获取自定义应用暴露的metrices的具体路径，不过这里写的要和service中做好约定</span></span><br><span class="line"><span class="comment"># 如果service中这样写 prometheus.io/app-metrics-path: &#x27;/metrics&#x27; 那么你这里就要__meta_kubernetes_service_annotation_prometheus_io_app_metrics_path这样写        </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line"><span class="comment"># 暴露自定义的应用的端口，就是把地址和你在service中定义的 &quot;prometheus.io/port = &lt;port&gt;&quot; 声明做一个拼接</span></span><br><span class="line"><span class="comment"># 然后赋值给__address__，这样prometheus就能获取自定义应用的端口，然后通过这个端口再结合__metrics_path__来获取</span></span><br><span class="line"><span class="comment"># 指标，如果__metrics_path__值不是默认的/metrics那么就要使用上面的标签替换来获取真正暴露的具体路径        </span></span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __address__</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: <span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line"><span class="comment"># 下面主要是为了给样本添加额外信息        </span></span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_name</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 下面是自动发现service，不过如果要想监控service则需要安装blackbox-exporter        </span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-services&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: service</span><br><span class="line">      metrics_path: /probe</span><br><span class="line"><span class="comment"># 生成__param_module=&quot;http_2xx&quot;的label，如果是TCP探测则使用 module: [tcp_connect]      </span></span><br><span class="line">      params:</span><br><span class="line">        module: [http_2xx]</span><br><span class="line">      relabel_configs:</span><br><span class="line"><span class="comment"># 为了让service可以被探测到，那需要在service的annotation中增加 prometheus.io/scrape: true 声明</span></span><br><span class="line"><span class="comment"># 也就是只保留prometheus.io/scrape: true的service      </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 用__address__这个label的值创建一个名为__param_target的label为blackbox-exporter,值为内部service的访问地址，作为blackbox-exporter采集用        </span></span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line"><span class="comment"># 用blackbox-exporter的service地址值”prometheus-blackbox-exporter:9115&quot;替换原__address__的值        </span></span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox-exporter.example.com:9115</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line"><span class="comment"># 下面主要是为了给样本添加额外信息        </span></span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">        target_label: kubernetes_name  </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 下面是对ingresses监控，不过如果要想监控ingresses则需要安装blackbox-exporter</span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-ingresses&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: ingress</span><br><span class="line">      </span><br><span class="line"><span class="comment"># 抓取POD进行监控</span></span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line"><span class="comment"># POD的 annotation 中含有&quot;prometheus.io/scrape: true&quot; 的则保留，意思就是会被Prometheus抓取，不具有这个的POD则不会被抓取      </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 获取POD的 annotation 中定义的&quot;prometheus.io/path: XXX&quot;定义的值，这个值就是你的程序暴露符合prometheus规范的metrics的地址</span></span><br><span class="line"><span class="comment"># 如果你的metrics的地址不是 /metrics 的话，通过这个标签，那么这里就会把这个值赋值给 __metrics_path__这个变量，因为prometheus</span></span><br><span class="line"><span class="comment"># 是通过这个变量获取路径然后进行拼接出来一个完整的URL，并通过这个URL来获取metrics值的，</span></span><br><span class="line"><span class="comment">#因为prometheus默认使用的就是 http(s)://X.X.X.X/metrics这样一个路径来获取的。        </span></span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line"><span class="comment"># 这里是端口信息，因为你的程序很有可能在容器中并不是以80端口运行的，那么就需要做一个拼接http(s)://x.x.x.x:xx/metrics</span></span><br><span class="line"><span class="comment"># __address__在prometheus中代表的就是实例的IP地址，而POD中的annotation 中定义的&quot;prometheus.io/port: XX&quot;就是你程序</span></span><br><span class="line"><span class="comment"># 被访问到的端口，最终在prometheus中将会被显示为 instance=X.X.X.X:XX这样        </span></span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: <span class="variable">$1</span>:<span class="variable">$2</span></span><br><span class="line">        target_label: __address__</span><br><span class="line"><span class="comment"># 下面主要是为了给样本添加额外信息         </span></span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br></pre></td></tr></table></figure>


<p>#prometheus是如何识别apiserver的呢？举个例子：</p>
<p># kubectl describe svc kubernetes</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Name:              kubernetes  <span class="comment">#__meta_kubernetes_service_name</span></span><br><span class="line">Namespace:         default     <span class="comment">#__meta_kubernetes_namespace</span></span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.1</span><br><span class="line">Port:              https  443/TCP  <span class="comment">#__meta_kubernetes_endpoint_port_name</span></span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         192.168.1.135:6443</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p># kubectl apply -f prometheus-config-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configmap/prometheus-config created</span><br></pre></td></tr></table></figure>

<p># vim prometheus-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-dep</span><br><span class="line">  namespace: prometheus</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus-dep</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus-dep</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:v2.16.0</span><br><span class="line">        imagePullPolicy: IfNotPresent </span><br><span class="line">        name: prometheus</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        args:</span><br><span class="line">        - <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="comment">#- &quot;--storage.tsdb.retention=1d&quot;  #storage.tsdb.retention: 已被废弃，改为使用storage.tsdb.retention.time</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.retention.time=1d&quot;</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">          name: data</span><br><span class="line">        - mountPath: <span class="string">&quot;/etc/prometheus&quot;</span></span><br><span class="line">          name: config-volume</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1000Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 2000m</span><br><span class="line">            memory: 4000Mi</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: regsecret</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-config</span><br></pre></td></tr></table></figure>

<p>prometheus-dep.yaml定义了prometheus的部署，这里使用–storage.tsdb.retention参数，监控数据只保留1天，因为最终监控数据会统一汇总。 limits资源限制根据集群大小进行适当调整。</p>
<p># kubectl apply -f  prometheus-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/prometheus-dep created</span><br></pre></td></tr></table></figure>

<p># vim prometheus-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-svc</span><br><span class="line">  namespace: prometheus</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    nodePort: 30090</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus-dep</span><br></pre></td></tr></table></figure>

<p>prometheus-svc.yaml定义Prometheus的Service，需要将Prometheus以NodePort、LoadBalancer或Ingress暴露到集群外部，这样外部的Prometheus才能访问它。这里采用的NodePort，所以只需要访问集群中有外网地址的任意一台服务器的30090端口就可以使用prometheus。</p>
<p>#注意：但是上面只是一个例子，实际场景呢可以用LoadBalancer，这样就不会因为Pod重启漂移而导致你的nodeip发送变化，而你接收端要进行变更，但是呢如果你担心你这个pod乱飘导致其他Node节点资源不足，可以绑定到某个Node上，这样就可以用NodePort方式了。</p>
<p># kubectl create -f prometheus-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service/prometheus-svc created</span><br></pre></td></tr></table></figure>

<h3 id="2-2-kube-state-metrics"><a href="#2-2-kube-state-metrics" class="headerlink" title="2.2 kube-state-metrics"></a>2.2 kube-state-metrics</h3><p>prometheus部署成功后，接着再部署kube-state-metrics作为prometheus的一个exporter来使用，提供deployment、daemonset、cronjob等服务的监控数据。</p>
<p># vim kube-state-metrics-rbac.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="comment"># kubernetes versions before 1.8.0 should use rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  namespace: prometheus</span><br><span class="line">  name: kube-state-metrics-resizer</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  resourceNames: [<span class="string">&quot;kube-state-metrics&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="comment"># kubernetes versions before 1.8.0 should use rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs: [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs: [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs: [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;batch&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - <span class="built_in">jobs</span></span><br><span class="line">  verbs: [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups: [<span class="string">&quot;autoscaling&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs: [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="comment"># kubernetes versions before 1.8.0 should use rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: kube-state-metrics-resizer</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="comment"># kubernetes versions before 1.8.0 should use rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br></pre></td></tr></table></figure>

<p>kube-state-metrics-rbac.yaml定义了kube-state-metrics访问k8s apiserver所需的ServiceAccount和ClusterRole及ClusterRoleBinding。</p>
<p># kubectl create -f  kube-state-metrics-rbac.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">serviceaccount/kube-state-metrics created</span><br><span class="line">role.rbac.authorization.k8s.io/kube-state-metrics-resizer created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics created</span><br></pre></td></tr></table></figure>

<p># vim kube-state-metrics-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line"><span class="comment"># Kubernetes versions after 1.9.0 should use apps/v1</span></span><br><span class="line"><span class="comment"># Kubernetes versions before 1.8.0 should use apps/v1beta1 or extensions/v1beta1</span></span><br><span class="line"><span class="comment"># addon-resizer描述：https://github.com/kubernetes/autoscaler/tree/master/addon-resizer</span></span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-state-metrics</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: quay.io/coreos/kube-state-metrics:v1.9.5</span><br><span class="line">        ports:</span><br><span class="line">        - name: http-metrics</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: telemetry</span><br><span class="line">          containerPort: 8081</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">      - name: addon-resizer</span><br><span class="line">          <span class="comment">#因为你知道的网络原因，这里使用阿里云的镜像源</span></span><br><span class="line">        <span class="comment">#image: gcr.io/bskiba-gke-dev/addon-resizer:1.8.7</span></span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/addon-resizer:1.8.7</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 30Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 30Mi</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          - name: MY_POD_NAME</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">          - name: MY_POD_NAMESPACE</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.namespace</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">          - /pod_nanny</span><br><span class="line">          - --container=kube-state-metrics</span><br><span class="line">          - --cpu=100m</span><br><span class="line">          - --extra-cpu=1m</span><br><span class="line">          - --memory=100Mi</span><br><span class="line">          - --extra-memory=2Mi</span><br><span class="line">          - --threshold=5</span><br><span class="line">          - --deployment=kube-state-metrics</span><br></pre></td></tr></table></figure>

<p>kube-state-metrics-dep.yaml定义了kube-state-metrics的部署。</p>
<p>插件伸缩 Addon Resizer: Addon resizer 是一个很有趣的小插件。如果用户在上述的场景中使用了Metrics Server，Metrics Server的资源占用量会随着集群中的Pod数量的不断增长而不断上升。Addon resizer 容器会以Sidecar的形式监控与自己同一个Pod内的另一个容器（在本例中是Metrics Server）并且垂直的扩展或收缩这个容器。Addon resizer能依据集群中节点的数量线性地扩展Metrics Server，以保证其能够有能力提供完整的metrics API服务。官网github地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler/tree/master/addon-resizer">https://github.com/kubernetes/autoscaler/tree/master/addon-resizer</a></p>
<p># kubectl create -f  kube-state-metrics-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/kube-state-metrics created</span><br></pre></td></tr></table></figure>

<p># vim kube-state-metrics-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: prometheus</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-state-metrics</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: http-metrics</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: telemetry</span><br><span class="line">    port: 8081</span><br><span class="line">    targetPort: telemetry</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-state-metrics</span><br></pre></td></tr></table></figure>

<p>kube-state-metrics-svc.yaml定义了kube-state-metrics的暴露方式，这里只需要使用默认的ClusterIP就可以了，因为它只提供给集群内部的promethes访问。</p>
<p># kubectl create -f  kube-state-metrics-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service/kube-state-metrics created</span><br></pre></td></tr></table></figure>

<p>k8s集群中的prometheus监控到这儿就已经全部OK了，接下来还需要做的是汇总数据、展示数据及告警规则配置。</p>
<h3 id="2-3-部署-数据汇总（注意后面哪些是可以不做的哈，只是列出用pod如何做）"><a href="#2-3-部署-数据汇总（注意后面哪些是可以不做的哈，只是列出用pod如何做）" class="headerlink" title="2.3 部署-数据汇总（注意后面哪些是可以不做的哈，只是列出用pod如何做）"></a>2.3 部署-数据汇总（注意后面哪些是可以不做的哈，只是列出用pod如何做）</h3><p>#个人还是推荐在物理机或者ECS机器上面部署prometheus-server用联邦模式进行k8s集群的数据采集和用altermanager集群模式进行报警。</p>
<p>prometheus-server：</p>
<p>       prometheus-server和前面prometheus的步骤基本相同，需要针对configmap、数据存储时间（一般为30d）、svc类型做些许改变，同时增加 rule.yaml。</p>
<p>      prometheus-server不需要kube-state-metrics。prometheus-server可以部署在任意k8s集群，或者部署在K8s集群外部都可以。</p>
<p>      prometheus-rbac.yaml (内容和上面的一致，namespace为prometheus-server)</p>
<p># kubectl create namespace prometheus-server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace/prometheus-server created</span><br></pre></td></tr></table></figure>

<p># vim prometheus-server-rbac.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">- nonResourceURLs: [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server</span><br><span class="line">  namespace: prometheus-server</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus-server</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus-server</span><br><span class="line">  namespace: prometheus-server</span><br></pre></td></tr></table></figure>

<p># kubectl create -f  prometheus-server-rbac.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus-server created</span><br><span class="line">serviceaccount/prometheus-server created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus-server created</span><br></pre></td></tr></table></figure>

<p># vim prometheus-server-config-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server-config</span><br><span class="line">  namespace: prometheus-server</span><br><span class="line">data:</span><br><span class="line">  prometheus.yml: |</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line">      scrape_timeout: 30s</span><br><span class="line">      evaluation_interval: 30s</span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - alertmanager-svc.prometheus-server.svc.cluster.local:80</span><br><span class="line">        scheme: http</span><br><span class="line">        <span class="built_in">timeout</span>: 10s</span><br><span class="line">    rule_files:</span><br><span class="line">    - <span class="string">&quot;/etc/prometheus/rule/rule.yml&quot;</span></span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: federate_test01</span><br><span class="line">      honor_labels: <span class="literal">true</span></span><br><span class="line">      params:</span><br><span class="line">        match[]:</span><br><span class="line">        - <span class="string">&#x27;&#123;job=~&quot;kubernetes-.*&quot;&#125;&#x27;</span></span><br><span class="line">      scrape_interval: 30s</span><br><span class="line">      scrape_timeout: 30s</span><br><span class="line">      metrics_path: /federate</span><br><span class="line">      scheme: http</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 192.168.1.137:31090  <span class="comment">#这里就是被采集的部署在k8s集群内部的prometheus的9090端口暴露在外面的svc的IP和端口</span></span><br><span class="line">        labels:</span><br><span class="line">          k8scluster: offline_51niux_k8s</span><br></pre></td></tr></table></figure>


<p>注意下面的labels，这个是自己定义的，它的作用在于给每一条刮取过来的监控数据都加上一个 k8scluster: offline_51niux_k8s 的Key-Value，offline一般指定为集群环境。这样我们可以在多个集群数据中区分该条数据是属于哪一个k8s集群，这对于后面的展示和告警都非常有利。</p>
<p># vim prometheus-server-rule-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server-rule-config</span><br><span class="line">  namespace: prometheus-server</span><br><span class="line">data:</span><br><span class="line">  rule.yml: |</span><br><span class="line">    <span class="built_in">groups</span>:</span><br><span class="line">    - name: kubernetes</span><br><span class="line">      rules:</span><br><span class="line">      - alert: PodDown</span><br><span class="line">        <span class="built_in">expr</span>: kube_pod_status_phase&#123;phase=<span class="string">&quot;Unknown&quot;</span>&#125; == 1 or kube_pod_status_phase&#123;phase=<span class="string">&quot;Failed&quot;</span>&#125; == 1</span><br><span class="line">        <span class="keyword">for</span>: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Pod Down</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          namespace: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">          pod: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.pod &#125;&#125;&quot;</span></span><br><span class="line">          container: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.container &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      - alert: PodRestart</span><br><span class="line">        <span class="built_in">expr</span>: changes(kube_pod_container_status_restarts_total&#123;pod !~ <span class="string">&quot;analyzer.*&quot;</span>&#125;[10m]) &gt; 0</span><br><span class="line">        <span class="keyword">for</span>: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Pod Restart</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          namespace: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">          pod: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.pod &#125;&#125;&quot;</span></span><br><span class="line">          container: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.container &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      - alert: NodeUnschedulable</span><br><span class="line">        <span class="built_in">expr</span>: kube_node_spec_unschedulable == 1</span><br><span class="line">        <span class="keyword">for</span>: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Node Unschedulable</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          node: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.node &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      - alert: NodeStatusError</span><br><span class="line">        <span class="built_in">expr</span>: kube_node_status_condition&#123;condition=<span class="string">&quot;Ready&quot;</span>, status!=<span class="string">&quot;true&quot;</span>&#125; == 1</span><br><span class="line">        <span class="keyword">for</span>: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Node Status Error</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          node: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.node &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      - alert: DaemonsetUnavailable</span><br><span class="line">        <span class="built_in">expr</span>: kube_daemonset_status_number_unavailable &gt; 0</span><br><span class="line">        <span class="keyword">for</span>: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Daemonset Unavailable</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          namespace: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">          daemonset: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.daemonset &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">      - alert: JobFailed</span><br><span class="line">        <span class="built_in">expr</span>: kube_job_status_failed == 1</span><br><span class="line">        <span class="keyword">for</span>: 5m</span><br><span class="line">        labels:</span><br><span class="line">          severity: error</span><br><span class="line">          service: prometheus_bot</span><br><span class="line">          receiver_group: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;_&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">        annotations:</span><br><span class="line">          summary: Job Failed</span><br><span class="line">          k8scluster: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.k8scluster&#125;&#125;&quot;</span></span><br><span class="line">          namespace: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.namespace &#125;&#125;&quot;</span></span><br><span class="line">          job: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.exported_job &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>rule.yaml定义了告警规则。此文件中定义了 PodDown、PodRestart、NodeUnschedulable、NodeStatusError、DaemonsetUnavailable、JobFailed 共6条规则。</p>
<p># vim prometheus-server-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server-dep</span><br><span class="line">  namespace: prometheus-server</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus-server-dep</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus-server-dep</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:v2.16.0</span><br><span class="line">        name: prometheus-server</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        args:</span><br><span class="line">        - <span class="string">&quot;--config.file=/etc/prometheus/config/prometheus.yml&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.console.libraries=/usr/share/prometheus/console_libraries&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.console.templates=/usr/share/prometheus&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.retention=30d&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.enable-lifecycle&quot;</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: <span class="string">&quot;data&quot;</span></span><br><span class="line">          mountPath: <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">        - name: <span class="string">&quot;server-config-volume&quot;</span></span><br><span class="line">          mountPath: <span class="string">&quot;/etc/prometheus/config&quot;</span></span><br><span class="line">        - name: <span class="string">&quot;rule-config-volume&quot;</span></span><br><span class="line">          mountPath: <span class="string">&quot;/etc/prometheus/rule&quot;</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 250m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">      serviceAccountName: prometheus-server</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        <span class="comment">#emptyDir: &#123;&#125; #volumes.data这里使用的是emptyDir，这样其实不妥，应该单独挂载一块盘来存储汇总数据。可使用pv实现。</span></span><br><span class="line">        hostPath:</span><br><span class="line">          path:  /data/prometheus</span><br><span class="line">      - name: server-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-server-config</span><br><span class="line">      - name: rule-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-server-rule-config</span><br><span class="line">      nodeSelector:</span><br><span class="line">        service-type: prometheus</span><br></pre></td></tr></table></figure>

<p>#mkdir &#x2F;data&#x2F;prometheus   -p  #实际场景这应该是一个挂载盘哈，但是你怎么知道它飘到哪个node节点呢？那就需要设置跟节点绑定了。</p>
<p># chmod 777 &#x2F;data&#x2F;prometheus  #不授权的话有下面的错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">component=activeQueryTracker msg=<span class="string">&quot;Error opening query log file&quot;</span> file=/prometheus/queries.active err=<span class="string">&quot;open /prometheus/queries.active: permission denied&quot;</span></span><br><span class="line">panic: Unable to create mmap-ed active query <span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p># kubectl create -f  prometheus-server-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/prometheus-server-dep created</span><br></pre></td></tr></table></figure>

<p>#如果Pod启动有问题可以使用：# kubectl describe pods 容器名   -n prometheus-server 或者# kubectl logs pods 容器名   -n prometheus-server排查一下问题。</p>
<p># vim prometheus-server-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-server-svc</span><br><span class="line">  namespace: prometheus-server</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 9090</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus-server-dep</span><br></pre></td></tr></table></figure>

<p> # kubectl create -f  prometheus-server-svc.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service/prometheus-server-svc created</span><br></pre></td></tr></table></figure>

<p>到这儿，数据采集和数据汇总就已经OK了。Prometheus-server部署成功之后，在浏览器中可以看到监控数据汇总信息了。</p>
<h3 id="2-4-告警配置"><a href="#2-4-告警配置" class="headerlink" title="2.4 告警配置"></a>2.4 告警配置</h3><p># vim alertmanager-config-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: prometheus</span><br><span class="line">data:</span><br><span class="line">  config.yml: |</span><br><span class="line">    global:</span><br><span class="line">        resolve_timeout: 5m</span><br><span class="line"></span><br><span class="line">        route:</span><br><span class="line">          receiver: default</span><br><span class="line">          group_wait: 30s</span><br><span class="line">          group_interval: 5m</span><br><span class="line">          repeat_interval: 4h</span><br><span class="line">          group_by: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;k8scluster&#x27;</span>, <span class="string">&#x27;node&#x27;</span>, <span class="string">&#x27;container&#x27;</span>, <span class="string">&#x27;exported_job&#x27;</span>, <span class="string">&#x27;daemonset&#x27;</span>]</span><br><span class="line">          routes:</span><br><span class="line">          - receiver: send_msg_warning</span><br><span class="line">                group_wait: 60s</span><br><span class="line">                match:</span><br><span class="line">                  severity: warning</span><br><span class="line"></span><br><span class="line">        receivers:</span><br><span class="line">        - name: default</span><br><span class="line">          webhook_configs:</span><br><span class="line">          - url: <span class="string">&#x27;http://msg.x.com/xxx/&#x27;</span></span><br><span class="line">                send_resolved: <span class="literal">true</span></span><br><span class="line">                http_config:</span><br><span class="line">                  bearer_token: <span class="string">&#x27;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">        - name: send_msg_warning</span><br><span class="line">          webhook_configs:</span><br><span class="line">          - url: <span class="string">&#x27;http://msg.x.com/xxx/&#x27;</span></span><br><span class="line">                send_resolved: <span class="literal">true</span></span><br><span class="line">                http_config:</span><br><span class="line">                  bearer_token: <span class="string">&#x27;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span></span><br></pre></td></tr></table></figure>

<p># kubectl create -f alertmanager-config-configmap.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configmap/alertmanager-config created</span><br></pre></td></tr></table></figure>

<p>alertmanager-config-configmap.yaml定义了alertmanager的配置文件</p>
<p>route：路由。分级匹配，然后交给指定 receivers，其中route.group_by中的k8scluster是prometheus-server-config.yaml中自定义的标签  </p>
<p>receivers：发送。这里使用webhook方式发送给自研的send_msg模块  </p>
<p>email、wechat、webhook、slack等发送方式配置请见官网文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/">https://prometheus.io/docs/alerting/configuration/</a>  </p>
<p># kubectl create namespace alertmanager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace/alertmanager created</span><br></pre></td></tr></table></figure>

<p># vim alertmanager-dep.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-dep</span><br><span class="line">  namespace: alertmanager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager-dep</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager-dep</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/alertmanager:v0.20.0</span><br><span class="line">        name: alertmanager</span><br><span class="line">        args:</span><br><span class="line">                - <span class="string">&quot;--config.file=/etc/alertmanager/config.yml&quot;</span></span><br><span class="line">                - <span class="string">&quot;--storage.path=/alertmanager&quot;</span></span><br><span class="line">                - <span class="string">&quot;--data.retention=720h&quot;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">&quot;/alertmanager&quot;</span></span><br><span class="line">          name: data</span><br><span class="line">        - mountPath: <span class="string">&quot;/etc/alertmanager&quot;</span></span><br><span class="line">          name: config-volume</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 2500Mi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br></pre></td></tr></table></figure>

<h1 id="kubectl-create-f-alertmanager-dep-yaml"><a href="#kubectl-create-f-alertmanager-dep-yaml" class="headerlink" title="kubectl create -f alertmanager-dep.yaml"></a>kubectl create -f alertmanager-dep.yaml</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/alertmanager-dep created</span><br></pre></td></tr></table></figure>

<p>alertmanager-dep.yaml定义了Alertmanager的部署。</p>
<h2 id="三、采集的各项指标的含义-可直接忽略就是蛋疼的整理了下，大部分用不到，需要再网上查"><a href="#三、采集的各项指标的含义-可直接忽略就是蛋疼的整理了下，大部分用不到，需要再网上查" class="headerlink" title="三、采集的各项指标的含义(可直接忽略就是蛋疼的整理了下，大部分用不到，需要再网上查)"></a>三、采集的各项指标的含义(可直接忽略就是蛋疼的整理了下，大部分用不到，需要再网上查)</h2><p># kubectl get –raw &#x2F;metrics  #从kube-apiserver拿到metrics信息</p>
<h3 id="3-1-job-”kubernetes-apiservers”"><a href="#3-1-job-”kubernetes-apiservers”" class="headerlink" title="3.1 job&#x3D;”kubernetes-apiservers”"></a>3.1 job&#x3D;”kubernetes-apiservers”</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">apiserver_admission_controller_admission_latencies_seconds_bucket   <span class="comment">#apiserver准入控制器准入等待时间单位秒bucket,里面还有不同标签有2000多项</span></span><br><span class="line">apiserver_request_latencies_bucket  <span class="comment">#apiserver请求等待时间bucket，里面还有不同的label有2000多项</span></span><br><span class="line">apiserver_response_sizes_bucket  <span class="comment">#apiserver响应大小bucket，里面还有不同的label有800多项</span></span><br><span class="line">apiserver_request_latencies_summary  <span class="comment">#apiserver请求延迟summary，里面有不同的label有400多项</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_bucket  <span class="comment">#apiserver允许step允许等待时间单位为秒bucket，有400多不同label的项。 </span></span><br><span class="line">apiserver_admission_controller_admission_latencies_seconds_count  <span class="comment">#apiserver接纳控制器接纳等待时间秒数，有400多不同label的项。</span></span><br><span class="line">apiserver_admission_controller_admission_latencies_seconds_sum  <span class="comment">#apiserver准入控制器准入等待时间秒数总和,有400多不同label项。</span></span><br><span class="line">apiserver_request_count  <span class="comment">#apiserver请求计数，有不到400个不同label项。</span></span><br><span class="line">reflector_list_duration_seconds  <span class="comment">#reflector list持续时间单位为秒，有不到300个不同的label项。</span></span><br><span class="line">reflector_items_per_list  <span class="comment">#reflector items每个清单，有不到300个不同的label项。</span></span><br><span class="line">reflector_watch_duration_seconds  <span class="comment">#reflector watch持续时间单位为秒，有不到300个不同的label项。</span></span><br><span class="line">reflector_items_per_watch  <span class="comment">#有不到300个不同的label项。</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_summary  <span class="comment">#apiserver允许step允许等待时间秒摘要，有200多个不同的label项。</span></span><br><span class="line">apiserver_request_latencies_summary_sum  <span class="comment">#apiserver请求延迟汇总，有不到200个不同的label项。</span></span><br><span class="line">apiserver_request_latencies_summary_count  <span class="comment">#apiserver请求延迟次数汇总，有不到200个不同的label项。</span></span><br><span class="line">apiserver_request_latencies_sum  <span class="comment">#apiserver请求延迟总和，有不到200个不同的label项。</span></span><br><span class="line">apiserver_request_latencies_count  <span class="comment">#apiserver请求延迟次数总和，有不到200个不同的label项。</span></span><br><span class="line">apiserver_response_sizes_count  <span class="comment">#apiserver响应大小计数，有不到200个不同的label项。</span></span><br><span class="line">apiserver_response_sizes_sum  <span class="comment">#apiserver响应大小总和，有100多个不同的label项。</span></span><br><span class="line">reflector_items_per_list_count   <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_last_resource_version  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_lists_total  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_items_per_watch_count  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_watch_duration_seconds_count  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_list_duration_seconds_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_items_per_watch_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_watch_duration_seconds_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_watches_total  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_short_watches_total  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_items_per_list_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">reflector_list_duration_seconds_count  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_summary_count  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_count  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">apiserver_admission_step_admission_latencies_seconds_summary_sum  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">rest_client_request_latency_seconds_bucket  <span class="comment">#有不到100个不同的label项。</span></span><br><span class="line">apiserver_longrunning_gauge  <span class="comment">#有50个不同的label项。</span></span><br><span class="line">etcd_object_counts  <span class="comment">#etcd对象计数，有50个不同的label项。</span></span><br><span class="line">apiserver_registered_watchers  <span class="comment">#apiserver注册watchers，有不到50个不同的label项。</span></span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_bucket  <span class="comment">#apiserver存储数据密钥生成延迟微秒级bucket，有不到20个不同的label项。</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket <span class="comment">#apiserver客户端证书到期秒数bucket，有不到20个不同的label项。</span></span><br><span class="line">rest_client_requests_total  <span class="comment">#其余客户端请求总数，有8个不同的label项。</span></span><br><span class="line">grpc_client_started_total  <span class="comment">#grpc客户端启动总数，有6个不同的label项。</span></span><br><span class="line">grpc_client_msg_sent_total  <span class="comment">#grpc客户端msg发送总计,有6个不同的label项。</span></span><br><span class="line">rest_client_request_latency_seconds_sum  <span class="comment">#其余客户端请求延迟秒数总和,有6个不同的label项。</span></span><br><span class="line">rest_client_request_latency_seconds_count  <span class="comment">#其余客户端请求延迟秒数,有6个不同的label项。</span></span><br><span class="line">grpc_client_handled_total  <span class="comment">#grpc客户端处理的总计，有5个不同的label项。</span></span><br><span class="line">apiserver_audit_level_total  <span class="comment">#apiserver审核级别总计，有4个不同的label项。</span></span><br><span class="line">admission_quota_controller_queue_latency  <span class="comment">#准入配额控制器队列延迟，有3个不同的label项。</span></span><br><span class="line">autoregister_queue_latency  <span class="comment">#自动注册队列延迟，有3个不同的label项。</span></span><br><span class="line">crdEstablishing_queue_latency  <span class="comment">#crd建立队列延迟，有3个不同的label项。</span></span><br><span class="line">autoregister_work_duration  <span class="comment">#自动注册工作时间，有3个不同的label项。</span></span><br><span class="line">http_response_size_bytes  <span class="comment">#http响应大小字节，有3个不同的label项。</span></span><br><span class="line">etcd_request_cache_get_latencies_summary  <span class="comment">#etcd请求缓存获取延迟summary，有3个不同的label项。</span></span><br><span class="line">APIServiceRegistrationController_work_duration  <span class="comment">#APIServiceRegistrationController工作持续时间，有3个不同的label项</span></span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_work_duration  <span class="comment">#APIServiceOpenAPIAggregationControllerQueue1的工作时间，有3个不同的label项</span></span><br><span class="line">APIServiceRegistrationController_queue_latency  <span class="comment">#APIServiceRegistrationController队列延迟，有3个不同的label项</span></span><br><span class="line">DiscoveryController_queue_latency  <span class="comment">#DiscoveryController队列延迟，有3个不同的label项</span></span><br><span class="line">AvailableConditionController_work_duration  <span class="comment">#AvailableConditionController工作时间，有3个不同的label项</span></span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_queue_latency  <span class="comment">#APIServiceOpenAPIAggregationControllerQueue1队列延迟，有3个不同的label项</span></span><br><span class="line">etcd_request_cache_add_latencies_summary  <span class="comment">#etcd请求缓存add延迟summary，有3个不同的label项</span></span><br><span class="line">http_request_size_bytes  <span class="comment">#http请求大小字节，有3个不同的label项</span></span><br><span class="line">AvailableConditionController_queue_latency  <span class="comment">#AvailableConditionController队列延迟，有3个不同的label项</span></span><br><span class="line">DiscoveryController_work_duration  <span class="comment">#DiscoveryController的工作时间，有3个不同的label项</span></span><br><span class="line">http_request_duration_microseconds  <span class="comment">#http请求持续时间微秒，有3个不同的label项</span></span><br><span class="line">admission_quota_controller_work_duration  <span class="comment">#admission_quota控制器的持续工作时间，有3个不同的label项</span></span><br><span class="line">crdEstablishing_work_duration  <span class="comment">#crd建立连接的工作时间，有3个不同的label项</span></span><br><span class="line">apiserver_current_inflight_requests  <span class="comment">#apiserver当前进行中的请求，有两个不同的label项</span></span><br><span class="line">get_token_fail_count  <span class="comment">#get token失败计数</span></span><br><span class="line">scrape_duration_seconds  <span class="comment">#采集时间单位为秒</span></span><br><span class="line">APIServiceRegistrationController_depth  <span class="comment">#APIServiceRegistrationController深度</span></span><br><span class="line">AvailableConditionController_queue_latency_count  <span class="comment">#AvailableConditionController队列延迟计数</span></span><br><span class="line">AvailableConditionController_retries  <span class="comment">#AvailableConditionController重试</span></span><br><span class="line">AvailableConditionController_work_duration_count  <span class="comment">#AvailableConditionController工作持续时间计数</span></span><br><span class="line">admission_quota_controller_work_duration_count  <span class="comment">#admission_quota_controller工作持续时间计数</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_sum  <span class="comment">#apiserver客户端证书到期秒数总和</span></span><br><span class="line">AvailableConditionController_work_duration_sum  <span class="comment">#AvailableConditionController工作持续时间总和</span></span><br><span class="line">etcd_helper_cache_miss_count  <span class="comment">#etcd helper缓存未命中计数</span></span><br><span class="line">DiscoveryController_queue_latency_count  <span class="comment">#DiscoveryController队列延迟计数</span></span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_depth  <span class="comment">#APIServiceOpenAPIAggregationControllerQueue1深度</span></span><br><span class="line">APIServiceRegistrationController_adds</span><br><span class="line">admission_quota_controller_adds</span><br><span class="line">etcd_request_cache_get_latencies_summary_count  <span class="comment">#etcd请求缓存获取延迟汇总计数</span></span><br><span class="line">http_request_duration_microseconds_sum  <span class="comment">#http请求持续时间微秒总和</span></span><br><span class="line">autoregister_work_duration_count  <span class="comment">#自动注册工作时间计数</span></span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_queue_latency_count  <span class="comment">#APIServiceOpenAPIAggregationControllerQueue1队列延迟计数</span></span><br><span class="line">autoregister_queue_latency_sum  <span class="comment">#自动注册队列延迟总和</span></span><br><span class="line">autoregister_retries  <span class="comment">#自动注册重试</span></span><br><span class="line">DiscoveryController_work_duration_count  <span class="comment">#DiscoveryController工作持续时间计数</span></span><br><span class="line">APIServiceRegistrationController_queue_latency_sum  <span class="comment">#APIServiceRegistrationController队列延迟总和</span></span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_adds</span><br><span class="line">AvailableConditionController_depth</span><br><span class="line">AvailableConditionController_queue_latency_sum</span><br><span class="line">APIServiceRegistrationController_work_duration_count</span><br><span class="line">apiserver_audit_event_total  <span class="comment">#apiserver审核事件总计</span></span><br><span class="line">etcd_request_cache_add_latencies_summary_count</span><br><span class="line">etcd_helper_cache_entry_count</span><br><span class="line">apiserver_storage_data_key_generation_failures_total  <span class="comment">#apiserver存储数据密钥生成失败总数</span></span><br><span class="line">DiscoveryController_adds</span><br><span class="line">admission_quota_controller_queue_latency_count</span><br><span class="line">admission_quota_controller_work_duration_sum</span><br><span class="line">etcd_helper_cache_hit_count</span><br><span class="line">up</span><br><span class="line">kubernetes_build_info  <span class="comment">#kubernetes构建信息</span></span><br><span class="line">http_response_size_bytes_count</span><br><span class="line">crdEstablishing_retries</span><br><span class="line">process_resident_memory_bytes</span><br><span class="line">http_response_size_bytes_sum</span><br><span class="line">DiscoveryController_retries  <span class="comment">#DiscoveryController重试</span></span><br><span class="line">admission_quota_controller_queue_latency_sum</span><br><span class="line">AvailableConditionController_adds</span><br><span class="line">etcd_request_cache_get_latencies_summary_sum</span><br><span class="line">http_request_size_bytes_count</span><br><span class="line">process_start_time_seconds</span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_retries</span><br><span class="line">admission_quota_controller_depth</span><br><span class="line">apiserver_storage_envelope_transformation_cache_misses_total</span><br><span class="line">autoregister_work_duration_sum</span><br><span class="line">crdEstablishing_work_duration_sum</span><br><span class="line">apiserver_client_certificate_expiration_seconds_count</span><br><span class="line">DiscoveryController_queue_latency_sum</span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_queue_latency_sum</span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_sum</span><br><span class="line">autoregister_depth</span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_work_duration_count</span><br><span class="line">crdEstablishing_queue_latency_sum</span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_count</span><br><span class="line">DiscoveryController_work_duration_sum</span><br><span class="line">etcd_request_cache_add_latencies_summary_sum</span><br><span class="line">APIServiceOpenAPIAggregationControllerQueue1_work_duration_sum</span><br><span class="line">scrape_samples_scraped</span><br><span class="line">APIServiceRegistrationController_queue_latency_count</span><br><span class="line">APIServiceRegistrationController_retries</span><br><span class="line">APIServiceRegistrationController_work_duration_sum</span><br></pre></td></tr></table></figure>

<h3 id="3-2-job-”kubernetes-cadvisor”"><a href="#3-2-job-”kubernetes-cadvisor”" class="headerlink" title="3.2 job&#x3D;”kubernetes-cadvisor”"></a>3.2 job&#x3D;”kubernetes-cadvisor”</h3><p>查看信息类型地址：<a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/metrics/testdata/prometheus/_metrics">https://github.com/google/cadvisor/blob/master/metrics/testdata/prometheus\_metrics</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">container_tasks_state  <span class="comment">#gauge类型，容器特定状态的任务数,根据不同的pod_name和state有600+的不同label.</span></span><br><span class="line">container_memory_failures_total  <span class="comment">#counter类型，内存分配失败的累积计数,根据不同的pod_name和state有600+的不同label.</span></span><br><span class="line">container_network_receive_errors_total  <span class="comment">#counter类型，容器网络接收时遇到的累计错误数。</span></span><br><span class="line">container_network_transmit_bytes_total  <span class="comment">#counter类型，容器发送传输的累计字节数。</span></span><br><span class="line">container_network_transmit_packets_dropped_total  <span class="comment">#counter类型，容器传输时丢弃的累计包数</span></span><br><span class="line">container_network_transmit_packets_total  <span class="comment">#counter类型，传输数据包的累计计数</span></span><br><span class="line">container_network_transmit_errors_total  <span class="comment">#counter类型，传输时遇到的累积错误数</span></span><br><span class="line">container_network_receive_bytes_total  <span class="comment">#counter类型，收到的累计字节数</span></span><br><span class="line">container_network_receive_packets_dropped_total  <span class="comment">#counter类型，接收时丢弃的累计数据包数</span></span><br><span class="line">container_network_receive_packets_total  <span class="comment">#counter类型，收到的累计数据包数</span></span><br><span class="line">container_spec_cpu_period  <span class="comment">#gauge类型，容器的CPU period。</span></span><br><span class="line">container_spec_memory_swap_limit_bytes  <span class="comment">#容器swap内存交换限制字节</span></span><br><span class="line">container_memory_failcnt  <span class="comment">#counter类型，内存使用次数达到限制</span></span><br><span class="line">container_spec_memory_reservation_limit_bytes  <span class="comment">#容器规格内存预留限制字节</span></span><br><span class="line">container_spec_cpu_shares  <span class="comment">#gauge类型，</span></span><br><span class="line">container_spec_memory_limit_bytes  <span class="comment">#容器规格内存限制字节</span></span><br><span class="line">container_memory_max_usage_bytes  <span class="comment">#gauge类型，以字节为单位记录的最大内存使用量</span></span><br><span class="line">container_cpu_load_average_10s  <span class="comment">#gauge类型，最近10秒钟内的容器CPU平均负载值。</span></span><br><span class="line">container_memory_rss  <span class="comment">#gauge类型，容器RSS的大小（以字节为单位）</span></span><br><span class="line">container_start_time_seconds  <span class="comment">#gauge类型，从Unix纪元开始的容器开始时间（以秒为单位）。</span></span><br><span class="line">container_memory_mapped_file  <span class="comment">#gauge类型，内存映射文件的大小（以字节为单位）</span></span><br><span class="line">container_cpu_user_seconds_total  <span class="comment">#conter类型，累计CPU user 时间（以秒为单位）</span></span><br><span class="line">container_memory_cache  <span class="comment">#gauge类型，内存的cache字节数。</span></span><br><span class="line">container_memory_working_set_bytes  <span class="comment">#gague类型，当前工作集（以字节为单位）</span></span><br><span class="line">container_cpu_system_seconds_total  <span class="comment">#conter类型，累计CPU system时间（以秒为单位）</span></span><br><span class="line">container_memory_swap  <span class="comment">#gauge类型，容器交换使用量（以字节为单位）</span></span><br><span class="line">container_memory_usage_bytes  <span class="comment">#gauge类型，当前内存使用情况（以字节为单位），包括所有内存，无论何时访问</span></span><br><span class="line">container_last_seen  <span class="comment">#gauge类型，上一次export看到此容器的时间</span></span><br><span class="line">container_fs_writes_total  <span class="comment">#counter类型，累计写入次数</span></span><br><span class="line">container_fs_reads_total   <span class="comment">#counter类型，类型读取次数</span></span><br><span class="line">container_cpu_usage_seconds_total  <span class="comment">#counter类型，累计消耗CPU的总时间</span></span><br><span class="line">container_fs_reads_bytes_total  <span class="comment">#容器读取的总字节数</span></span><br><span class="line">container_fs_writes_bytes_total  <span class="comment">#容器写入的总字节数</span></span><br><span class="line">container_fs_sector_reads_total  <span class="comment">#counter类型，扇区已完成读取的累计计数</span></span><br><span class="line">container_fs_inodes_free  <span class="comment">#gauge类型，可用的Inode数量</span></span><br><span class="line">container_fs_io_current  <span class="comment">#gauge类型，当前正在进行的I/O数</span></span><br><span class="line">container_fs_io_time_weighted_seconds_total  <span class="comment">#counter类型，累积加权I/O时间（以秒为单位）</span></span><br><span class="line">container_fs_usage_bytes  <span class="comment">#gauge类型，此容器在文件系统上使用的字节数</span></span><br><span class="line">container_fs_limit_bytes  <span class="comment">#gauge类型，此容器文件系统上可以使用的字节数</span></span><br><span class="line">container_fs_inodes_total  <span class="comment">#gauge类型，inode数</span></span><br><span class="line">container_fs_sector_writes_total  <span class="comment">#counter类型，扇区写入累计计数</span></span><br><span class="line">container_fs_io_time_seconds_total  <span class="comment">#counter类型，I/O花费的秒数累计</span></span><br><span class="line">container_fs_writes_merged_total  <span class="comment">#counter类型，合并的累计写入数</span></span><br><span class="line">container_fs_reads_merged_total  <span class="comment">#counter类型，合并的累计读取数</span></span><br><span class="line">container_fs_write_seconds_total  <span class="comment">#counter类型，写花费的秒数累计</span></span><br><span class="line">container_fs_read_seconds_total   <span class="comment">#counter类型，读花费的秒数累计</span></span><br><span class="line">container_cpu_cfs_periods_total  <span class="comment">#counter类型，执行周期间隔时间数</span></span><br><span class="line">container_cpu_cfs_throttled_periods_total  <span class="comment">#counter类型，节流周期间隔数</span></span><br><span class="line">container_cpu_cfs_throttled_seconds_total  <span class="comment">#counter类型，容器被节流的总时间</span></span><br><span class="line">container_spec_cpu_quota  <span class="comment">#gauge类型，容器的CPU配额</span></span><br><span class="line">machine_memory_bytes  <span class="comment">#gauge类型，机器上安装的内存量</span></span><br><span class="line">scrape_samples_post_metric_relabeling</span><br><span class="line">cadvisor_version_info</span><br><span class="line">scrape_duration_seconds</span><br><span class="line">machine_cpu_cores  <span class="comment">#gauge类型，机器上的CPU核心数</span></span><br><span class="line">container_scrape_error  <span class="comment">#gauge类型，如果获取容器指标时出错，则为1，否则为0</span></span><br><span class="line">scrape_samples_scraped</span><br></pre></td></tr></table></figure>

<h3 id="3-3-job-”kubernetes-nodes”"><a href="#3-3-job-”kubernetes-nodes”" class="headerlink" title="3.3 job&#x3D;”kubernetes-nodes”"></a>3.3 job&#x3D;”kubernetes-nodes”</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">storage_operation_duration_seconds_bucket</span><br><span class="line">kubelet_runtime_operations_latency_microseconds  <span class="comment">#summary类型，（不建议使用）运行时操作的延迟（以微秒为单位）。 按操作类型细分</span></span><br><span class="line">rest_client_request_latency_seconds_bucket</span><br><span class="line">kubelet_docker_operations_latency_microseconds  <span class="comment">#summary类型，（不建议使用）Docker操作的延迟（以微秒为单位）。 按操作类型细分。</span></span><br><span class="line">kubelet_runtime_operations  <span class="comment">#counter类型，（不建议使用）按操作类型划分的运行时操作累计数。</span></span><br><span class="line">kubelet_runtime_operations_latency_microseconds_count</span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_bucket</span><br><span class="line">kubelet_runtime_operations_latency_microseconds_sum</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket</span><br><span class="line">kubelet_docker_operations_latency_microseconds_sum</span><br><span class="line">kubelet_docker_operations  <span class="comment">#counter类型，（已弃用）按操作类型分类的Docker操作的累计数量。</span></span><br><span class="line">kubelet_docker_operations_latency_microseconds_count</span><br><span class="line">rest_client_requests_total  <span class="comment">#counter类型，HTTP请求数，按状态码，方法和主机划分。</span></span><br><span class="line">kubelet_cgroup_manager_latency_microseconds  <span class="comment">#summary类型，（不建议使用）cgroup Manager操作的延迟（以微秒为单位）。 按方法细分。</span></span><br><span class="line">storage_operation_duration_seconds_sum</span><br><span class="line">storage_operation_duration_seconds_count</span><br><span class="line">kubelet_network_plugin_operations_latency_microseconds  <span class="comment">#summary类型，(不建议使用）网络插件操作的延迟（以微秒为单位）。 按操作类型细分。</span></span><br><span class="line">volume_manager_total_volumes  <span class="comment">#gauge类型，Volume Manager中的卷数</span></span><br><span class="line">kubelet_pod_worker_latency_microseconds  <span class="comment">#summary类型，（不建议使用）延迟（以微秒为单位）以同步单个Pod。 按操作类型细分：创建，更新或同步</span></span><br><span class="line">kubelet_docker_operations_errors  <span class="comment">#counter类型，（已弃用）按操作类型分类的Docker操作错误累计数。</span></span><br><span class="line">kubelet_runtime_operations_errors  <span class="comment">#counter类型，（不建议使用）按操作类型累计的运行时操作错误数。</span></span><br><span class="line">rest_client_request_latency_seconds_count</span><br><span class="line">rest_client_request_latency_seconds_sum</span><br><span class="line">http_request_size_bytes  <span class="comment">#summary类型，HTTP请求大小（以字节为单位）。</span></span><br><span class="line">kubelet_pleg_relist_latency_microseconds  <span class="comment">#summary类型，（已弃用）重新列出PLEG中的Pod的延迟（以微秒为单位）。</span></span><br><span class="line">kubelet_pod_worker_start_latency_microseconds  <span class="comment">#summary类型，（已弃用）从看到容器到开始工作的等待时间（以微秒为单位）。</span></span><br><span class="line">kubelet_cgroup_manager_latency_microseconds_sum</span><br><span class="line">kubelet_network_plugin_operations_latency_microseconds_sum</span><br><span class="line">http_request_duration_microseconds  <span class="comment">#summary类型，HTTP请求延迟（以微秒为单位）。</span></span><br><span class="line">kubelet_cgroup_manager_latency_microseconds_count</span><br><span class="line">http_response_size_bytes  <span class="comment">#summary类型，HTTP响应大小（以字节为单位）。</span></span><br><span class="line">kubelet_pod_start_latency_microseconds  <span class="comment">#summary类型，（已弃用）单个Pod从挂起到运行的延迟（以微秒为单位）。</span></span><br><span class="line">kubelet_containers_per_pod_count  <span class="comment">#histogram类型，每个pod的容器数。</span></span><br><span class="line">kubelet_network_plugin_operations_latency_microseconds_count</span><br><span class="line">kubelet_pleg_relist_interval_microseconds  <span class="comment">#summary类型，（已弃用）在PLEG中重新上市之间的间隔（以微秒为单位）。</span></span><br><span class="line">kubelet_pod_worker_latency_microseconds_sum</span><br><span class="line">kubelet_pod_worker_latency_microseconds_count</span><br><span class="line">storage_operation_errors_total  <span class="comment">#counter类型，存储操作错误总数。</span></span><br><span class="line">process_resident_memory_bytes  <span class="comment">#gauge类型，驻留内存大小（以字节为单位）。</span></span><br><span class="line">kubelet_certificate_manager_client_expiration_seconds  <span class="comment">#gauge类型，证书生命周期的量度。 该值是证书自UTC 1970年1月1日起过期的秒数。</span></span><br><span class="line">kubelet_running_container_count  <span class="comment">#gauge类型，当前正在运行的容器数</span></span><br><span class="line">http_request_size_bytes_sum</span><br><span class="line">kubelet_pleg_relist_latency_microseconds_count</span><br><span class="line">http_request_duration_microseconds_count</span><br><span class="line">kubelet_pod_worker_start_latency_microseconds_count</span><br><span class="line">kubelet_pleg_relist_interval_microseconds_sum</span><br><span class="line">scrape_samples_scraped</span><br><span class="line">process_open_fds</span><br><span class="line">kubelet_pod_worker_start_latency_microseconds_sum</span><br><span class="line">apiserver_storage_data_key_generation_failures_total  <span class="comment">#counter类型，失败的数据加密密钥（DEK）生成操作的总数。</span></span><br><span class="line">http_request_size_bytes_count</span><br><span class="line">kubelet_running_pod_count  <span class="comment">#gauge类型，当前运行的pod数</span></span><br><span class="line">kubelet_node_config_error  <span class="comment">#gauge类型，如果节点遇到与配置相关的错误，则此指标为true（1），否则为false（0）。</span></span><br><span class="line">kubelet_pod_start_latency_microseconds_count</span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_count</span><br><span class="line">kubelet_pleg_relist_latency_microseconds_sum</span><br><span class="line">process_virtual_memory_bytes</span><br><span class="line">scrape_samples_post_metric_relabeling</span><br><span class="line">process_start_time_seconds</span><br><span class="line">kubelet_pod_start_latency_microseconds_sum</span><br><span class="line">apiserver_client_certificate_expiration_seconds_sum</span><br><span class="line">kubelet_containers_per_pod_count_count</span><br><span class="line">http_response_size_bytes_count</span><br><span class="line">kubernetes_build_info</span><br><span class="line">http_response_size_bytes_sum</span><br><span class="line">apiserver_audit_event_total  <span class="comment">#counter类型，生成审计事件的计数器，并将其发送到审计后端。</span></span><br><span class="line">kubelet_containers_per_pod_count_sum</span><br><span class="line">kubelet_pleg_relist_interval_microseconds_count</span><br><span class="line">apiserver_storage_envelope_transformation_cache_misses_total  <span class="comment">#counter类型，访问密钥解密密钥（KEK）时缓存未命中总数。</span></span><br><span class="line">scrape_duration_seconds</span><br><span class="line">apiserver_storage_data_key_generation_latencies_microseconds_sum</span><br><span class="line">http_request_duration_microseconds_sum</span><br><span class="line">apiserver_client_certificate_expiration_seconds_count</span><br></pre></td></tr></table></figure>

<h3 id="3-4-job-”kubernetes-pods”"><a href="#3-4-job-”kubernetes-pods”" class="headerlink" title="3.4 job&#x3D;”kubernetes-pods”"></a>3.4 job&#x3D;”kubernetes-pods”</h3><p>#这里部署的是nginx_ingress_controller  下面是查询这些metric类型和意思的网址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/master/internal/ingress/metric/collectors/nginx_status_test.go">https://github.com/kubernetes/ingress-nginx/blob/master/internal/ingress/metric/collectors/nginx_status_test.go</a></p>
<p><a target="_blank" rel="noopener" href="https://www.gitmemory.com/issue/kubernetes/ingress-nginx/2924/483591581">https://www.gitmemory.com/issue/kubernetes/ingress-nginx/2924/483591581</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nginx_ingress_controller_nginx_process_connections  <span class="comment">#gauge类型，状态为&#123;active, reading, writing, waiting&#125;的当前客户端连接数</span></span><br><span class="line">nginx_ingress_controller_nginx_process_connections_total  <span class="comment">#counter类型，状态为&#123;accepted, handled（已接受，已处理）&#125;的连接总数</span></span><br><span class="line">nginx_ingress_controller_config_last_reload_successful  <span class="comment">#gauge类型，nginx_ingress_controller_config最后一次加载成功的时间</span></span><br><span class="line">nginx_ingress_controller_nginx_process_write_bytes_total <span class="comment">#counter类型，nginx_ingress_controller nginx进程写入字节总数</span></span><br><span class="line">nginx_ingress_controller_config_hash  <span class="comment">#gauge类型，实际正在运行配置散列</span></span><br><span class="line">nginx_ingress_controller_config_last_reload_successful_timestamp_seconds   <span class="comment">#gauge类型，上一次成功重新配置的时间戳。</span></span><br><span class="line">nginx_ingress_controller_nginx_process_num_procs  <span class="comment">#gauge类型，进程数</span></span><br><span class="line">nginx_ingress_controller_nginx_process_oldest_start_time_seconds  <span class="comment">#gauge类型，从1970/01/01开始的秒数</span></span><br><span class="line">nginx_ingress_controller_nginx_process_virtual_memory_bytes  <span class="comment">#guage类型，正在使用的内存字节数</span></span><br><span class="line">nginx_ingress_controller_success  <span class="comment">#counter类型，Ingress控制器重新加载操作的累积数量</span></span><br><span class="line">nginx_ingress_controller_nginx_process_read_bytes_total  <span class="comment">#counter类型，读取的字节数</span></span><br><span class="line">nginx_ingress_controller_nginx_process_cpu_seconds_total  <span class="comment">#counter类似，CPU使用时间（以秒为单位）</span></span><br><span class="line">nginx_ingress_controller_nginx_process_requests_total  <span class="comment">#counter类型，客户请求总数</span></span><br><span class="line">nginx_ingress_controller_nginx_process_resident_memory_bytes  <span class="comment">#gauge类型，正在使用的内存字节数</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-job-”kubernetes-service-endpoints”"><a href="#3-5-job-”kubernetes-service-endpoints”" class="headerlink" title="3.5 job&#x3D;”kubernetes-service-endpoints”"></a>3.5 job&#x3D;”kubernetes-service-endpoints”</h3><p>coredns的查看指标地址：<a target="_blank" rel="noopener" href="https://github.com/DataDog/integrations-core/blob/master/coredns/tests/fixtures/metrics.txt">https://github.com/DataDog/integrations-core/blob/master/coredns/tests/fixtures/metrics.txt</a></p>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2023/12/26/Prometheus%E7%9B%91%E6%8E%A7Kubernetes/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prometheus/" rel="tag">Prometheus</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/12/27/vmbackup%E5%92%8Cvmrestore%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            vmbackup和vmrestore使用介绍
          
        </div>
      </a>
    
    
      <a href="/2023/12/26/Prometheus%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Prometheus之自动发现</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2024
        <i class="ri-heart-fill heart_icon"></i> JinTao Li
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="https://beian.miit.gov.cn/" target="_black" rel="nofollow">鲁ICP备88888888</a>
        </li>
        
    </ul>
    <ul>
      
      <li>
          <img src="/images/beian.png"></img>
          <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=01234567890123" target="_black" rel="nofollow">青岛公安网备01234567890123号</a>
      </li>
        
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Lijintao&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://blog.csdn.net/u013235026">CSDN</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/jintaoli">博客园</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/images/272a163694dd8a415a43dbf85ac34778.jpg">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=2049529248&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    
<script>
  const password = "jintao1210";
  const lock_password = window.sessionStorage.getItem("lock_password");
  console.log(password, lock_password);
  if (lock_password !== password) {
    Swal.fire({
      title: "请输入访问密码",
      input: "text",
      inputAttributes: {
        autocapitalize: "off",
      },
      showCancelButton: false,
      showLoaderOnConfirm: true,
      allowOutsideClick: false,
      confirmButtonText: "确定",
    }).then((result) => {
      console.log(result);
      if (result.isConfirmed) {
        console.log(password);
        if (result.value === password) {
          window.sessionStorage.setItem("lock_password", result.value);
        } else {
          Swal.fire({
            icon: "error",
            title: "密码错误，请重试",
            confirmButtonText: "确定",
            allowOutsideClick: false,
          }).then(() => {
            window.location.reload();
          });
        }
      }
    });
  }
</script>


  </div>
</body>

</html>